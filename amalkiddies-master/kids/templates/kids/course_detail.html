{% extends 'base.html' %}
{% load dict_extras %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-body">
          <h2 class="fw-bold mb-2" style="color:#2d6a4f;"><i class="bi bi-palette" style="color:#ff595e;"></i> {{ course.name }}</h2>
          <span class="badge bg-info">{{ course.subject.name }}</span>
          <span class="badge bg-success">{{ course.level }}</span>
          <span class="badge bg-warning text-dark">Ages {{ course.age_group.min_age }}-{{ course.age_group.max_age }}</span>
          <p class="mt-3" style="font-size:1.1rem;">{{ course.description }}</p>
        </div>
      </div>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h4 class="mb-3 text-primary"><i class="bi bi-lightbulb"></i> Lessons</h4>
          {% if not enrolled %}
            <form method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-success mb-3">Start Course</button>
            </form>
            <div class="alert alert-warning">You must start the course to access lessons.</div>
          {% endif %}

          <style>
            .lesson-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
              gap: 22px;
              margin-top: 10px;
            }
            .lesson-card {
              background: linear-gradient(135deg, #e0f7fa 0%, #f8f9fa 100%);
              border-radius: 16px;
              box-shadow: 0 2px 12px rgba(44, 62, 80, 0.10);
              transition: box-shadow 0.3s, transform 0.3s;
              position: relative;
              overflow: hidden;
              animation: fadeInUp 0.7s;
            }
            .lesson-card:hover {
              box-shadow: 0 8px 32px rgba(44, 62, 80, 0.18);
              transform: translateY(-6px) scale(1.03);
            }
            @keyframes fadeInUp {
              from { opacity: 0; transform: translateY(24px); }
              to { opacity: 1; transform: translateY(0); }
            }
            .lesson-badge {
              font-size: 0.9rem;
              margin-right: 8px;
            }
            .lesson-icon {
              font-size: 1.5rem;
              margin-right: 10px;
              color: #00b4d8;
            }
            .lesson-title {
              font-weight: 600;
              font-size: 1.08rem;
              color: #264653;
            }
            .lesson-status {
              position: absolute;
              top: 16px;
              right: 16px;
            }
            .lesson-content {
              font-size: 0.97rem;
              color: #495057;
              margin-bottom: 8px;
            }
            .progress-bar {
              height: 6px;
              background: #caf0f8;
              border-radius: 3px;
              margin-bottom: 8px;
              overflow: hidden;
            }
            .progress-bar-inner {
              height: 100%;
              background: linear-gradient(90deg, #00b4d8 0%, #90e0ef 100%);
              width: 100%;
              border-radius: 3px;
              transition: width 0.4s;
            }
          </style>
          {% if lessons %}
            <div class="lesson-grid">
              {% for lesson in lessons %}
                {% with completion=completion_map|dict_get:lesson.id %}
                <div class="lesson-card p-3 position-relative">
                  <div class="progress-bar mb-2">
                    <div class="progress-bar-inner" style="width:100%"></div>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <span class="lesson-icon"><i class="bi bi-journal-bookmark"></i></span>
                    <span class="lesson-title flex-grow-1">{{ lesson.title }}</span>
                    <span class="lesson-status">
                      {% if not enrolled %}
                        <span class="badge bg-secondary lesson-badge">Locked</span>
                      {% endif %}
                    </span>
                  </div>
                  <div class="lesson-content">
                    {{ lesson.content|linebreaks }}
                  </div>
                  {% if enrolled %}
                    <div class="lesson-action-btn" style="position:absolute; right:18px; bottom:18px; display:flex; align-items:center; gap:8px;">
                      {% if completion and completion.completed_quiz %}
                        <span style="background:#38d39f; color:white; font-weight:600; border-radius:8px; padding:4px 14px; font-size:0.95rem; box-shadow:0 2px 8px rgba(44,62,80,0.10);">Completed</span>
                        <a href="{% url 'lesson_detail' lesson.id %}" class="btn btn-outline-success btn-sm">Review Lesson <i class="bi bi-check2"></i></a>
                      {% else %}
                        <span style="background:#38d39f; color:white; font-weight:600; border-radius:8px; padding:4px 14px; font-size:0.95rem; box-shadow:0 2px 8px rgba(44,62,80,0.10);">Unlocked</span>
                        <a href="{% url 'lesson_detail' lesson.id %}" class="btn btn-primary btn-sm">Go to Lesson <i class="bi bi-arrow-right"></i></a>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="lesson-action-btn" style="position:absolute; left:18px; bottom:18px;">
                      <button class="btn btn-secondary btn-sm" disabled>Locked</button>
                    </div>
                  {% endif %}
                </div>
                {% endwith %}
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info">No lessons available yet for this course.</div>
          {% endif %}
        </div>
      </div>
      <a href="{% url 'kids_online_platform' %}" class="btn btn-secondary">Back to Courses</a>
    </div>
  </div>
</div>
{% endblock %}
