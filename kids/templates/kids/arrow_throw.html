<!-- Removed main header by not extending users/basic.html -->
<style>
  html, body {
    width: 100vw;
    max-width: 100vw;
    overflow-x: hidden;
    background: #181a20 !important;
    color: #f5f5f5 !important;
  }
  .container, .card, .card-body, .scoreboard-box {
    background: #181a20 !important;
    color: #f5f5f5 !important;
  }
  .card {
    border: 1px solid #23272f;
    box-shadow: 0 2px 12px #23272f44;
    margin: 0 auto;
    max-width: 420px;
  }
  .card-body {
    padding: 0.5rem 0.5rem 1.5rem 0.5rem !important;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .scoreboard-box {
    background: #23272f !important;
    border: 4px solid #ffe066 !important;
    color: #f5f5f5 !important;
  width: 100%;
  max-width: 1400px;
  font-size: 3.2rem;
  margin: 3rem auto 0 auto;
  box-sizing: border-box;
  padding: 3.5rem 2.5rem;
  }
  .score-label {
  color: #ffe066 !important;
  font-size: 2.2rem !important;
  font-weight: 700;
  }
  #gameArea {
    width: 100vw;
    max-width: 700px;
  margin: 4cm auto 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding-top: 1rem;
    padding-bottom: 1rem;
    box-sizing: border-box;
    overflow-x: hidden;
    overflow-y: auto;
    min-height: 100vh;
  }
  #dartboard {
    background: #181a20 !important;
    border: 2px solid #ffe066 !important;
    box-shadow: 0 2px 12px #23272f44 !important;
    width: 98vw;
    height: 98vw;
    display: block;
    margin: 0 auto;
    touch-action: manipulation;
  }
  .btn-primary {
    background: #ffe066 !important;
    color: #23272f !important;
    border: none;
    margin-top: 1rem;
    font-size: 1.1rem;
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
  }
  .alert-danger {
    background: #23272f !important;
    color: #ff4066 !important;
    border: 1px solid #ff4066 !important;
  }
  @media (max-width: 600px) {
    html, body {
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
    }
    .container, .card {
      padding: 0 !important;
      margin: 0 !important;
      max-width: 100vw !important;
      overflow-x: hidden;
    }
    #gameArea {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
    }
    .scoreboard-box {
      min-width: 0;
      max-width: 98vw;
      font-size: 0.95rem;
      padding: 0.5rem;
    }
    #dartboard {
      width: 20vw !important;
      height: 8vw !important;
      margin: 0 auto;
      display: block;
    }
  }
</style>
{% block content %}
{% if error_message %}
  <div class="container py-3">
    <div class="mb-3 text-center">
      <strong>Today's Attempts:</strong>
      {% if attempts_list and attempts_list|length > 0 %}
        <ul style="list-style:none; padding-left:0;">
        {% for attempt_time in attempts_list %}
          <li>{{ attempt_time }}</li>
        {% endfor %}
        </ul>
      {% else %}
        <span>No attempts yet today.</span>
      {% endif %}
    </div>
  </div>
  <div class="container py-5">
    <div class="alert alert-danger text-center" style="font-size:1.3rem; border-radius:16px; box-shadow:0 2px 12px #ff406633;">
      <i class="fas fa-exclamation-triangle" style="font-size:2rem; color:#ff4066;"></i><br>
      {{ error_message }}
      {% if wait_time %}
        <div class="mt-2" style="font-size:1.1rem; color:#23272f;">
          You can try again in <strong>{{ wait_time }}</strong>.
        </div>
      {% endif %}
    </div>
    <div class="text-center mt-4">
      <a href="/" class="btn btn-primary">Back to Home</a>
    </div>
  </div>
{% else %}
<div id="gameArea">
  <canvas id="dartboard" width="700" height="700" style="width:98vw;max-width:700px;height:98vw;max-height:700px;display:block;margin:2rem auto 0 auto;border-radius:50%;border:2px solid #ffe066;box-shadow:0 2px 12px #23272f44;cursor:crosshair;touch-action:manipulation;"></canvas>
  <div class="mt-3">
  <h4 id="scoreDisplay" style="font-size:2.5rem; font-weight:800; color:#ffe066;">Score: 0</h4>
  <h5 id="rewardDisplay" style="font-size:2rem; font-weight:700; color:#00e676;"></h5>
  </div>
  <div id="levelTransition" style="display:none;">
    <h3 class="text-warning">Level Up!</h3>
    <p>Speed increased. Get ready!</p>
  </div>
  <button id="replayBtn" class="btn btn-primary mt-3" style="display:none;" onclick="resetGame()">Replay</button>
  <div class="scoreboard-container mt-3 mb-2 d-flex justify-content-center">
    <div class="scoreboard-box p-3" style="background:#222; border:4px solid #ffe066; border-radius:14px; box-shadow:0 2px 12px #000a; min-width:320px; max-width:700px; font-size:1.3rem;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="score-label" style="font-size:2.2rem; color:#fff; font-weight:700; letter-spacing:1px;">Level</span>
                <span id="levelDisplay" style="font-size:2.5rem; color:#ffe066; font-weight:800;">1</span>
              </div>
              <div class="progress mb-2" style="height:12px; background:#333; border-radius:6px;">
                <div id="levelProgress" class="progress-bar" style="width:0%; background:#ffe066; border-radius:6px;"></div>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="score-label" style="font-size:2.2rem; color:#fff; font-weight:700;">Try</span>
                <span id="tryDisplay" style="font-size:2.5rem; color:#00e676; font-weight:800;">0</span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="score-label" style="font-size:2.2rem; color:#fff; font-weight:700;">Total</span>
                <span id="totalDisplay" style="font-size:2.5rem; color:#fff; font-weight:800;">0</span>
              </div>
              <hr style="border-top:4px solid #ffe066; margin:12px 0;">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="score-label" style="font-size:2rem; color:#ffe066; font-weight:700;">Average Points</span>
                <span id="avgDisplay" style="font-size:2.2rem; color:#ffe066; font-weight:800;">0</span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="score-label" style="font-size:2rem; color:#00e676; font-weight:700;">Coins</span>
                <span id="coinsDisplay" style="font-size:2.2rem; color:#00e676; font-weight:800;">0</span>
              </div>
              <div class="mt-1 text-center">
                <span id="rewardDisplay" style="font-size:1rem; color:#ffe066; font-weight:600;"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<form id="coinForm" method="POST" action="/update_coins/" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="coins" id="finalCoinsInput" value="0">
</form>
<script>
var kidsHomeUrl = "/kids/";
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('dartboard');
  const ctx = canvas.getContext('2d');
  let centerX, centerY, radius;
  function resizeCanvas() {
    // Match CSS: width:90vw;max-width:600px;height:90vw;max-height:600px;
  let size = Math.min(window.innerWidth * 0.98, 700);
    canvas.width = size;
    canvas.height = size;
    centerX = canvas.width / 2;
    centerY = canvas.height / 2;
    radius = canvas.width / 2 - 20;
  }
  resizeCanvas();
  window.addEventListener('resize', function() {
    resizeCanvas();
    drawBoard(rotation);
  });
  const sectors = 20;
  const sectorScores = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
  let rotation = 0;
  let animationFrame;
  let lastDart = null;
  let wheelStopped = false;
  let hitSectorIdx = null;
  let level = 1;
  let tries = 0;
  let maxLevels = 3;
  let maxTries = 5;
  let scores = [];
  let gameStarted = true;
  let totalScore = 0;
  function drawBoard(rot) {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const maxScore = Math.max(...sectorScores);
    const maxSectorIdx = sectorScores.indexOf(maxScore);
    for(let i=0;i<sectors;i++){
      let a1 = ((i/sectors)*2*Math.PI) + rot;
      let a2 = (((i+1)/sectors)*2*Math.PI) + rot;
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, a1, a2);
      ctx.closePath();
      if (typeof hitSectorIdx === 'number' && i === hitSectorIdx) {
        ctx.fillStyle = '#00e676';
        ctx.globalAlpha = 1;
        ctx.shadowColor = '#00e676';
        ctx.shadowBlur = 30;
      } else if (i === maxSectorIdx) {
        ctx.fillStyle = '#e040fb';
        ctx.globalAlpha = 0.95;
        ctx.shadowColor = '#e040fb';
        ctx.shadowBlur = 30;
      } else {
        ctx.fillStyle = i%2==0 ? '#ffe066' : '#23272f';
        ctx.globalAlpha = 0.8;
        ctx.shadowBlur = 0;
      }
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.stroke();
      let midAngle = (a1+a2)/2;
      let tx = centerX + Math.cos(midAngle)*(radius-30);
      let ty = centerY + Math.sin(midAngle)*(radius-30);
      ctx.save();
      ctx.translate(tx, ty);
      ctx.rotate(midAngle+Math.PI/2);
      ctx.font = 'bold 18px Montserrat';
      ctx.fillStyle = '#ff4066';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(sectorScores[i], 0, 0);
      ctx.restore();
      ctx.restore();
    }
    ctx.beginPath();
    ctx.arc(centerX, centerY, 20, 0, 2*Math.PI);
    ctx.fillStyle = '#ff3b3b';
    ctx.fill();
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.stroke();
    if (lastDart) {
      drawDartShape(ctx, lastDart.x, lastDart.y, 0);
    }
  }
  let baseSpeed = 0.03;
  let speedIncrement = 0.005;
  function animateBoard() {
    if (!wheelStopped) {
      rotation += baseSpeed + (level-1)*speedIncrement;
      animationFrame = requestAnimationFrame(animateBoard);
    }
    drawBoard(rotation);
  }
  function cancelAnimation() {
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }
  }
  animateBoard();
  function drawDartShape(ctx, x, y, angle) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(-20, 0);
    ctx.lineTo(20, 0);
    ctx.lineWidth = 6;
    ctx.strokeStyle = '#444';
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(22, 0, 3, 0, 2 * Math.PI);
    ctx.fillStyle = '#ff4066';
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(-20, 0);
    ctx.lineTo(-26, -8);
    ctx.lineTo(-26, 8);
    ctx.closePath();
    ctx.fillStyle = '#ffe066';
    ctx.fill();
    ctx.restore();
  }
  function resetGame() {
    level = 1;
    tries = 0;
    scores = [];
    totalScore = 0;
    wheelStopped = false;
    lastDart = null;
    hitSectorIdx = null;
    rotation = 0;
    document.getElementById('levelDisplay').innerText = 1;
    document.getElementById('tryDisplay').innerText = 0;
    document.getElementById('scoreDisplay').innerText = 0;
    document.getElementById('totalDisplay').innerText = 0;
    document.getElementById('coinsDisplay').innerText = 0;
    document.getElementById('levelProgress').style.width = '0%';
    document.getElementById('rewardDisplay').innerText = '';
    document.getElementById('replayBtn').style.display = 'none';
    drawBoard(rotation);
    cancelAnimation();
    animateBoard();
  }
  function handleThrow(x, y) {
    if (!gameStarted) return;
    if (wheelStopped) return;
    if (tries >= maxTries) return;
    const rect = canvas.getBoundingClientRect();
    x = x - rect.left;
    y = y - rect.top;
    const frozenRotation = rotation;
    wheelStopped = true;
    cancelAnimation();
    let t = 0, steps = 20;
    let finalDart = {x: x, y: y, angle: 0};
    let score = 0;
    let dx = x - centerX, dy = y - centerY;
    let dist = Math.sqrt(dx*dx + dy*dy);
    let hitSectorIdx = null;
    if(dist <= radius) {
      let angle = Math.atan2(dy, dx) - frozenRotation;
      if(angle < 0) angle += 2*Math.PI;
      let sectorIdx = Math.floor((angle/(2*Math.PI))*sectors);
      sectorIdx = ((sectorIdx % sectors) + sectors) % sectors;
      hitSectorIdx = sectorIdx;
      finalDart.x = x;
      finalDart.y = y;
      finalDart.angle = angle + frozenRotation;
      score = sectorScores[hitSectorIdx];
    }
    function drawDart() {
      drawBoard(frozenRotation);
      let currX = centerX + (finalDart.x-centerX)*(t/steps);
      let currY = centerY + (finalDart.y-centerY)*(t/steps);
      let dartAngle = Math.atan2(centerY-currY, centerX-currX);
      drawDartShape(ctx, currX, currY, dartAngle);
      t++;
      if(t <= steps) {
        requestAnimationFrame(drawDart);
      } else {
        lastDart = {...finalDart};
        drawBoard(frozenRotation);
        totalScore += score;
        scores.push(score);
        tries++;
        document.getElementById('levelDisplay').innerText = level;
        document.getElementById('tryDisplay').innerText = tries;
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('totalDisplay').innerText = totalScore;
        document.getElementById('levelProgress').style.width = ((level-1)/(maxLevels-1)*100) + '%';
        let avgScore = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
        let points = Math.round(totalScore / (scores.length || 1));
        document.getElementById('avgDisplay').innerText = avgScore.toFixed(2);
        document.getElementById('coinsDisplay').innerText = points;
        let reward = '';
        if(score >= 50) reward = '🏆 Bullseye! You won 50 points!';
        else if(score >= 20) reward = '🎉 You won 20 points!';
        else if(score >= 10) reward = '👍 You won 10 points!';
        else if(score > 0) reward = '👏 You won 5 points!';
        else reward = '😢 No reward, try again!';
        document.getElementById('rewardDisplay').innerText = reward;
        if (tries < maxTries) {
          setTimeout(() => {
            wheelStopped = false;
            lastDart = null;
            drawBoard(rotation);
            cancelAnimation();
            animateBoard();
          }, 1000);
        } else {
          if (level < maxLevels) {
            setTimeout(() => {
              level++;
              tries = 0;
              wheelStopped = false;
              lastDart = null;
              rotation = 0;
              document.getElementById('scoreDisplay').innerText = `Level: ${level} | Try: 0 | Score: 0 | Total: ${totalScore}`;
              document.getElementById('rewardDisplay').innerText = `Level up! Speed increased.`;
              drawBoard(rotation);
              cancelAnimation();
              animateBoard();
            }, 1200);
          } else {
            let avgScore = scores.reduce((a,b)=>a+b,0)/scores.length;
            let coins = Math.round(avgScore);
            document.getElementById('avgDisplay').innerText = avgScore.toFixed(2);
            document.getElementById('coinsDisplay').innerText = coins;
            document.getElementById('rewardDisplay').innerText = `🏅 You won ${coins} coins!`;
            document.getElementById('finalCoinsInput').value = coins;
            // Redirect to kids home page after game finishes
            setTimeout(function() {
              window.location.href = kidsHomeUrl;
            }, 15000);
            document.getElementById('replayBtn').style.display = 'inline-block';
            document.getElementById('avgDisplay').innerText = avgScore.toFixed(2);
            document.getElementById('coinsDisplay').innerText = coins;
          }
        }
      }
    }
    drawDart();
  }
  canvas.onclick = function(e) {
    handleThrow(e.clientX, e.clientY);
  };
  canvas.addEventListener('touchend', function(e) {
    if (e.changedTouches && e.changedTouches.length > 0) {
      handleThrow(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    }
  });
});
</script>
{% endif %}
{% endblock %}
