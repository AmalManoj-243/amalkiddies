
{% extends 'users/basic.html' %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body.scratch-bg {
    background: linear-gradient(135deg, #181a20 0%, #23272f 100%);
    min-height: 100vh;
  }
  .scratch-card-dark {
    background: linear-gradient(135deg, #23272f 0%, #181a20 100%);
    border-radius: 24px;
    box-shadow: 0 8px 32px rgba(20,22,32,0.45);
    border: 2px solid #ffd700;
    position: relative;
    overflow: visible;
    min-height: 320px;
    max-width: 98vw;
    margin: 0 auto;
    padding: 0;
    transition: box-shadow 0.4s;
    animation: borderGlowGold 2s infinite alternate;
  }
  @keyframes borderGlowGold {
    from { box-shadow: 0 0 16px #ffd700, 0 8px 32px #23272f; }
    to { box-shadow: 0 0 32px #ffd700, 0 16px 64px #181a20; }
  }
  .scratch-header {
    background: linear-gradient(90deg, #23272f 0%, #181a20 100%);
    color: #ffd700;
    border-top-left-radius: 32px;
    border-top-right-radius: 32px;
    padding: 1.5rem 0.5rem;
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: 2px;
    box-shadow: 0 2px 12px #181a20;
    text-transform: uppercase;
    text-shadow: 0 2px 8px #ffd700, 0 1px 0 #23272f;
  }
  .scratch-canvas-wrap {
    position: relative;
    width: 340px;
    height: 120px;
    margin: 0 auto;
    margin-bottom: 24px;
    background: #23272f;
    border-radius: 24px;
    border: 3px solid #ffd700;
    box-shadow: 0 2px 16px #23272f;
    overflow: hidden;
  }
  .scratch-canvas {
    position: relative;
    z-index: 2;
    border-radius: 24px;
    background: transparent;
    cursor: pointer;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    display: block;
  }
  .scratch-reward, .scratch-none {
    position: absolute;
    left: 0; top: 0; width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 3;
  }
  .scratch-reward span {
    font-size: 2rem;
    font-weight: 900;
    color: #ffd700;
    background: linear-gradient(90deg,#23272f 0%,#181a20 100%);
    text-shadow: 0 2px 16px #ffd700, 0 1px 0 #23272f;
    border-radius: 16px;
    padding: 1.2rem 2rem;
    box-shadow: 0 2px 16px #23272f, 0 0 16px #ffd700;
    letter-spacing: 2px;
    opacity: 0;
    transition: opacity 0.4s, box-shadow 0.4s;
    animation: glowGold 1.5s infinite alternate;
  }
  @keyframes glowGold {
    from { box-shadow: 0 2px 16px #23272f, 0 0 16px #ffd700; }
    to { box-shadow: 0 4px 24px #ffd700, 0 0 32px #23272f; }
  }
  .scratch-none span {
    font-size: 1.4rem;
    font-weight: 700;
    color: #bbb;
    background: linear-gradient(90deg,#23272f 0%,#181a20 100%);
    border-radius: 16px;
    padding: 1.2rem 2rem;
    box-shadow: 0 2px 16px #23272f;
    letter-spacing: 2px;
    opacity: 0;
    transition: opacity 0.4s;
  }
  .scratch-progress {
    width: 340px;
    height: 12px;
    background: linear-gradient(90deg, #23272f 0%, #181a20 100%);
    border-radius: 8px;
    margin: 18px auto 0 auto;
    box-shadow: 0 1px 4px #23272f;
    overflow: hidden;
    position: relative;
    z-index: 1;
  }
  .scratch-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffd700 0%, #23272f 100%);
    border-radius: 8px;
    transition: width 0.3s;
    width: 0%;
  }
  .confetti {
    position: absolute;
    left: 0; top: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 10;
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('scratch-bg');
    var canvas = document.getElementById('scratchCanvas');
    var rewardText = document.getElementById('rewardText');
    var noneText = document.getElementById('noneText');
    var progressBar = document.getElementById('scratchProgressBar');
    var confetti = document.getElementById('confetti');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var isDrawing = false;
    var width = canvas.width;
    var height = canvas.height;
    ctx.fillStyle = '#ffe066'; // lighter gold for visibility
    ctx.fillRect(0, 0, width, height);
    ctx.globalCompositeOperation = 'destination-out';
    function getPointer(e) {
      var rect = canvas.getBoundingClientRect();
      var x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      var y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      return {x, y};
    }
    function scratch(e) {
      if (!isDrawing) return;
      e.preventDefault();
      var point = getPointer(e);
      ctx.beginPath();
      ctx.arc(point.x, point.y, 28, 0, 2 * Math.PI);
      ctx.fill();
      updateProgress();
    }
    function updateProgress() {
      var imageData = ctx.getImageData(0, 0, width, height);
      var pixels = imageData.data;
      var transparent = 0;
      for (var i = 3; i < pixels.length; i += 4) {
        if (pixels[i] === 0) transparent++;
      }
      var percent = transparent / (width * height) * 100;
      if (progressBar) progressBar.style.width = Math.min(percent, 100) + '%';
      // Show only one: reward or none
      if (rewardText && noneText) {
        var rewardSpan = rewardText.querySelector('span');
        var noneSpan = noneText.querySelector('span');
        if (percent > 40) {
          if (rewardSpan && rewardSpan.textContent.trim() !== '') {
            rewardSpan.style.opacity = '1';
            noneSpan.style.opacity = '0';
          } else {
            rewardSpan.style.opacity = '0';
            noneSpan.style.opacity = '1';
          }
        } else {
          rewardSpan.style.opacity = '0';
          noneSpan.style.opacity = '0';
        }
      }
      if (percent > 40 && confetti && !confetti.classList.contains('active')) {
        confetti.classList.add('active');
        launchConfetti();
      }
    }
    function launchConfetti() {
      for (let i = 0; i < 60; i++) {
        let div = document.createElement('div');
        div.style.position = 'absolute';
        div.style.width = '8px';
        div.style.height = '8px';
        div.style.borderRadius = '50%';
        div.style.background = '#ffd700';
        div.style.left = Math.random() * 100 + '%';
        div.style.top = '0%';
        div.style.opacity = 0.8;
        div.style.transform = `scale(${0.7 + Math.random() * 0.6})`;
        div.style.transition = 'top 1.2s cubic-bezier(.2,.8,.2,1), opacity 1.2s';
        confetti.appendChild(div);
        setTimeout(() => {
          div.style.top = '100%';
          div.style.opacity = 0;
        }, 50);
        setTimeout(() => {
          confetti.removeChild(div);
        }, 1400);
      }
    }
    canvas.addEventListener('mousedown', function(e) { isDrawing = true; });
    canvas.addEventListener('mousemove', function(e) { if (isDrawing) scratch(e); });
    canvas.addEventListener('mouseup', function() { isDrawing = false; });
    canvas.addEventListener('mouseleave', function() { isDrawing = false; });
    canvas.addEventListener('touchstart', function(e) { isDrawing = true; });
    canvas.addEventListener('touchmove', function(e) { if (isDrawing) scratch(e); });
    canvas.addEventListener('touchend', function() { isDrawing = false; });
    if (rewardText && noneText) {
      var rewardSpan = rewardText.querySelector('span');
      var noneSpan = noneText.querySelector('span');
      rewardSpan.style.opacity = '0';
      noneSpan.style.opacity = '0';
    }
    if (progressBar) progressBar.style.width = '0%';
  });
</script>
<div class="container mt-3 mb-4 py-4">
  <div class="row justify-content-center">
    <div class="col-lg-7 col-md-10">
      <div class="scratch-card-dark text-center shadow-lg position-relative" style="min-height:420px;">
        <div id="confetti" class="confetti"></div>
        <div class="scratch-header">
          <span>Scratch Card Game</span>
        </div>
        <div class="card-body py-4 position-relative" style="min-height:200px;">
          <div class="mt-3 position-relative d-flex flex-column align-items-center" style="height:200px;">
            <div class="scratch-canvas-wrap">
              <div id="rewardText" class="scratch-reward">
                {% if reward %}
                  <span>ðŸŽ‰ {{ reward }} ðŸŽ‰</span>
                {% else %}
                  <span></span>
                {% endif %}
              </div>
              <div id="noneText" class="scratch-none">
                {% if not reward %}
                  <span>No Rewards</span>
                {% else %}
                  <span></span>
                {% endif %}
              </div>
              <canvas id="scratchCanvas" class="scratch-canvas" width="340" height="120"></canvas>
            </div>
            <div class="scratch-progress mt-3">
              <div id="scratchProgressBar" class="scratch-progress-bar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
