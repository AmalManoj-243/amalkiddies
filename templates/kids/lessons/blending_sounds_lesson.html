{% extends 'base.html' %}
{% block content %}
<style>
  body {
    background: linear-gradient(120deg, #e0f7fa 0%, #ffd6e0 100%, #f8ffae 120%);
  }
  .hero-section {
    background: linear-gradient(135deg, #fffbe6 0%, #e0f7fa 100%);
    border-radius: 2.5rem;
    box-shadow: 0 12px 40px #ffd60a33;
    padding: 3rem 2rem 1.5rem 2rem;
    margin-bottom: 2.5rem;
    text-align: center;
    position: relative;
  }
  .hero-mascot {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    background: #fffbe6;
    box-shadow: 0 6px 24px #ffd60a22;
    display: inline-block;
    margin-bottom: 1.2rem;
    animation: bounceMascot 1.2s infinite alternate;
  }
  @keyframes bounceMascot {
    0% { transform: translateY(0); }
    100% { transform: translateY(-16px); }
  }
  .hero-title {
    color: #ff4066;
    font-family: 'Baloo 2', cursive;
    font-size: 2.7rem;
    font-weight: bold;
    margin-bottom: 1rem;
    letter-spacing: 2px;
    text-shadow: 0 2px 12px #ffd60a44;
  }
  .hero-desc {
    font-size: 1.5rem;
    color: #005f73;
    margin-bottom: 1.5rem;
    font-family: 'Comic Sans MS', cursive;
  }
  .blend-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1.2rem;
    justify-items: center;
    margin: 2rem auto 1.5rem auto;
    max-width: 800px;
  }
  .blend-card, .letter-card {
    border-radius: 1.2rem;
    box-shadow: 0 4px 18px #ffd60a33, 0 2px 8px #e0f7fa88;
    background: linear-gradient(135deg, #e0f7fa 60%, #fffbe6 100%);
    padding: 1.2rem 0.5rem;
    font-size: 2.1rem;
    font-family: 'Baloo 2', cursive;
    color: #2d6a4f;
    font-weight: bold;
    transition: transform 0.25s, box-shadow 0.25s, background 0.25s;
    cursor: pointer;
    position: relative;
    margin-bottom: 1.2rem;
    will-change: transform, box-shadow, background;
    animation: bounceIn 0.8s;
    text-align: center;
    border: 3px solid #ffd60a;
    min-height: 70px;
    min-width: 70px;
    user-select: none;
  }
  .blend-card:hover, .letter-card:hover {
    transform: scale(1.09) rotate(-2deg);
    box-shadow: 0 16px 40px #ffd60a55, 0 2px 8px #e0f7fa88;
    background: linear-gradient(135deg, #ffe066 60%, #fffbe6 100%);
    z-index: 2;
    border-color: #ff4066;
  }
  .build-area {
    background: #fffbe6;
    border-radius: 1.5rem;
    box-shadow: 0 4px 18px #ffd60a33;
    padding: 2rem 1.2rem;
    margin: 2rem auto;
    max-width: 600px;
    min-height: 120px;
    text-align: center;
    font-size: 2.2rem;
    font-family: 'Baloo 2', cursive;
    color: #2d6a4f;
    position: relative;
  }
  .build-word {
    display: inline-block;
    min-width: 80px;
    font-size: 2.5rem;
    font-weight: bold;
    color: #ff4066;
    margin: 0 0.5rem;
    letter-spacing: 2px;
    border-bottom: 2px dashed #ffd60a;
    padding: 0.2rem 0.7rem;
    background: #e0f7fa;
    border-radius: 1rem;
  }
  .build-img {
    max-width: 80px;
    margin: 0.7rem auto 0.2rem auto;
    border-radius: 1rem;
    box-shadow: 0 4px 16px #ffd60a33;
    background: #fffbe6;
    display: block;
    border: 2px solid #e0f7fa;
    transition: box-shadow 0.2s, border 0.2s;
  }
  .confetti {
    position: fixed;
    left: 50vw;
    top: 50vh;
    font-size: 2.5rem;
    pointer-events: none;
    animation: confettiAnim 1.2s ease-out;
  }
  @keyframes confettiAnim {
    0% { opacity: 1; transform: scale(1) translateY(0); }
    100% { opacity: 0; transform: scale(1.5) translateY(80px); }
  }
  .quiz-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.7rem;
    background: linear-gradient(90deg,#ffd60a 0%,#ff9800 100%);
    color: #2d6a4f;
    border-radius: 2.2rem;
    font-size: 1.5rem;
    font-family: 'Baloo 2', cursive;
    font-weight: bold;
    box-shadow: 0 4px 18px #ffd60a88, 0 2px 8px #ff406655;
    padding: 1.1rem 2.7rem;
    margin-top: 1.2rem;
    border: 3px solid #ff4066;
    transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    text-decoration: none;
    position: relative;
    overflow: hidden;
  }
  .quiz-btn:hover {
    transform: scale(1.08) rotate(-2deg);
    background: #ff4066;
    color: #fff;
    box-shadow: 0 8px 24px #ffd60a44;
  }
</style>
<div class="container py-4">
  <div class="hero-section">
    <img src="https://cdn-icons-png.flaticon.com/512/189/189665.png" alt="Mascot" class="hero-mascot" id="mascotImg">
    <div class="hero-title">Blending Sounds & Word Building</div>
    <div class="hero-desc">Learn to blend sounds step-by-step! Practice, get hints, earn rewards, and master word building.</div>
    <div id="progressBar" style="width:100%;height:18px;background:#e0f7fa;border-radius:12px;margin:1rem 0;">
      <div id="progressFill" style="height:100%;width:0;background:#ffd60a;border-radius:12px;transition:width 0.5s;"></div>
    </div>
    <div id="streakTracker" style="font-size:1.2rem;color:#ff4066;font-weight:bold;margin-bottom:0.7rem;"></div>
  </div>
  {% if video_embed_url %}
  <div class="video-section" style="text-align:center;margin-bottom:2rem;">
    <iframe width="560" height="315" style="max-width:100%;border-radius:1.2rem;box-shadow:0 4px 18px #ffd60a33;" src="{{ video_embed_url }}" title="Lesson Video" frameborder="0" allowfullscreen></iframe>
  </div>
  {% endif %}
  <div class="guided-section" style="background:#fffbe6;border-radius:1.2rem;box-shadow:0 4px 18px #ffd60a33;padding:1.2rem;margin-bottom:1.5rem;">
    <div id="guidedBlending" style="font-size:1.5rem;color:#2d6a4f;font-family:'Baloo 2',cursive;"></div>
    <button onclick="nextGuided()" class="quiz-btn" style="margin-top:1rem;">Next Example</button>
  </div>
    <div class="practice-section" style="background:#e0f7fa;border-radius:1.2rem;box-shadow:0 4px 18px #ffd60a33;padding:0.7rem 0.5rem;margin-bottom:1.2rem;max-width:600px;margin-left:auto;margin-right:auto;">
      <div style="font-size:1.2rem;color:#005f73;margin-bottom:0.5rem;display:flex;justify-content:space-between;align-items:center;">
        <span>Practice Mode: Build words by blending sounds!</span>
        <button onclick="togglePractice()" style="font-size:1.1rem;padding:0.2rem 1rem;border-radius:1rem;background:#ffd60a;color:#2d6a4f;border:none;box-shadow:0 2px 8px #ffd60a33;">Hide/Show</button>
      </div>
      <div id="practiceContent">
        <div class="blend-grid" id="blendGrid" style="grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:0.7rem;max-width:400px;"></div>
        <div class="blend-grid" id="letterGrid" style="grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:0.7rem;max-width:400px;"></div>
        <div class="build-area" id="buildArea" style="padding:1rem 0.5rem;min-height:80px;">
          <span id="buildWord" class="build-word"></span>
          <img id="buildImg" class="build-img" style="display:none;max-width:60px;" />
          <div id="buildFeedback" style="font-size:1.1rem; color:#005f73; margin-top:0.5rem;"></div>
          <div id="hintArea" style="font-size:1rem;color:#ff9800;margin-top:0.3rem;"></div>
          <button onclick="resetPractice()" class="quiz-btn" style="margin-top:0.7rem;padding:0.5rem 1.2rem;font-size:1rem;">Reset</button>
        </div>
      </div>
    </div>
<script>
function togglePractice() {
  var el = document.getElementById('practiceContent');
  if (el.style.display === 'none') {
    el.style.display = '';
  } else {
    el.style.display = 'none';
  }
}
</script>
  <!-- Challenge section removed for cleaner UI -->
  <div class="text-center">
    <a href="/kids/lessons/blending-quiz/" class="quiz-btn">
      <span style="font-size:2.2rem; vertical-align:middle; animation:bounceMascot 1.2s infinite alternate;">üéÆ</span>
      <span style="font-size:1.7rem; vertical-align:middle;">Take the Blending Quiz!</span>
      <span style="font-size:1.7rem; vertical-align:middle;">üìù</span>
      <span style="position:absolute; right:18px; top:18px; font-size:1.3rem; color:#ffd60a; animation: bounceIn 1.2s infinite alternate;">‚≠ê</span>
    </a>
  </div>
    <div class="review-section" style="background:#e0f7fa;border-radius:1.2rem;box-shadow:0 4px 18px #ffd60a33;padding:1rem 0.7rem;margin-top:1.2rem;max-width:600px;margin-left:auto;margin-right:auto;">
      <div style="font-size:1.2rem;color:#005f73;margin-bottom:0.5rem;">Review: Words you built and sounds you learned</div>
      <ul id="reviewList" style="text-align:left;font-size:1rem;color:#2d6a4f;"></ul>
    </div>
</div>
<script>
const mascotPhrases = [
  "Great job! Keep blending!",
  "Try sounding out each part!",
  "You‚Äôre a word-building star!",
  "Listen carefully and blend again!",
  "Awesome! Can you do it faster?",
  "If you‚Äôre stuck, look for hints!"
];
const blends = ['at', 'an', 'ap', 'et', 'en', 'ot', 'op', 'it', 'in', 'ig', 'id', 'ip', 'im', 'un', 'ut', 'ug', 'up', 'ub', 'ed', 'eg', 'en', 'et', 'ob', 'og', 'op', 'ot', 'ox', 'ow', 'oy', 'uck', 'ack', 'ick', 'ock', 'uck', 'eck', 'ock', 'ash', 'ish', 'ush', 'est', 'ost', 'ant', 'ent', 'int', 'ont', 'unt'];
const letters = ['c', 'b', 'p', 'm', 's', 'r', 't', 'h', 'l', 'f', 'd', 'g', 'n', 'j', 'v', 'w', 'z', 'y', 'a', 'e', 'o', 'u', 'i'];
const words = {
  'cat': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bat': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pan': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'man': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fan': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'mat': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pat': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'cap': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tap': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'top': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pot': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'ten': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pen': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pet': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rat': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'ran': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lot': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lap': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sat': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'son': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'big': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dig': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dog': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fog': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'log': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'jog': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'mop': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'hop': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pop': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'cop': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'zip': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lip': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sip': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tip': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'win': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fin': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bin': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pin': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tin': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'van': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'can': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fan': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'man': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pan': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tan': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'den': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'hen': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'men': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pen': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'ten': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'web': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bed': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'red': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'led': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fed': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'peg': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'leg': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'beg': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'wag': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tag': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bag': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rag': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'nag': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'cab': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dab': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'jab': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lab': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tab': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rob': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sob': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'job': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'cob': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bob': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fox': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'box': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'ox': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'mix': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fix': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'six': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'wax': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'max': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tax': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sack': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pack': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'back': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rack': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tack': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'duck': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'luck': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sick': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'kick': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pick': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tick': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rock': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sock': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lock': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dock': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'peck': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'deck': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'neck': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'ash': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'cash': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dash': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'mash': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rash': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'wish': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dish': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'fish': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'hush': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rush': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bush': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'nest': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'best': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'test': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'west': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'cost': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lost': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'most': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'ant': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'pant': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'rant': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'sent': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'tent': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'mint': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'hint': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'lint': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'font': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'hunt': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'bunt': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'punt': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'dunk': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'junk': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'funk': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
  'chunk': {img: 'https://cdn-icons-png.flaticon.com/512/616/616408.png'},
};
let currentBuild = '';
let streak = 0;
let progress = 0;
let reviewWords = [];
let challengeActive = false;
let challengeScore = 0;
let challengeTimer = 0;
let guidedIndex = 0;
const guidedExamples = [
  {parts: ['c', 'at'], word: 'cat'},
  {parts: ['b', 'at'], word: 'bat'},
  {parts: ['m', 'an'], word: 'man'},
  {parts: ['p', 'an'], word: 'pan'},
  {parts: ['f', 'an'], word: 'fan'},
  {parts: ['r', 'at'], word: 'rat'},
  {parts: ['t', 'op'], word: 'top'},
  {parts: ['c', 'ap'], word: 'cap'},
  {parts: ['t', 'ap'], word: 'tap'},
];
function showMascotFeedback(msg) {
  document.getElementById('mascotImg').title = msg;
}
function updateStreak(val) {
  streak = val;
  document.getElementById('streakTracker').textContent = 'Streak: ' + streak;
}
function updateProgress(val) {
  progress = val;
  document.getElementById('progressFill').style.width = (progress * 10) + '%';
}
function showHint(msg) {
  document.getElementById('hintArea').textContent = msg;
}
function updateReview() {
  const list = document.getElementById('reviewList');
  list.innerHTML = '';
  reviewWords.forEach(w => {
    list.innerHTML += `<li><b>${w.word}</b> (${w.parts.join(' + ')})</li>`;
  });
}
function showGuidedBlending() {
  const ex = guidedExamples[guidedIndex % guidedExamples.length];
  let html = '';
  html += `<span style='color:#ff4066;font-size:2.1rem;'>${ex.parts[0]}</span> + <span style='color:#ffd60a;font-size:2.1rem;'>${ex.parts[1]}</span> = <span style='color:#2d6a4f;font-size:2.1rem;'>${ex.word}</span> `;
  html += `<button onclick='playGuidedSound()' style='margin-left:1rem;font-size:1.2rem;'>üîä Hear</button>`;
  document.getElementById('guidedBlending').innerHTML = html;
  showMascotFeedback(mascotPhrases[Math.floor(Math.random()*mascotPhrases.length)]);
}
function playGuidedSound() {
  const ex = guidedExamples[guidedIndex % guidedExamples.length];
  let utter = new SpeechSynthesisUtterance(`${ex.parts[0]}, ${ex.parts[1]}, ${ex.word}`);
  utter.lang = 'en-US';
  utter.pitch = 1.2;
  utter.rate = 1.1;
  window.speechSynthesis.speak(utter);
}
function nextGuided() {
  guidedIndex++;
  showGuidedBlending();
  updateProgress(guidedIndex);
}
function renderCards() {
  const blendGrid = document.getElementById('blendGrid');
  blendGrid.innerHTML = '';
  blends.forEach(blend => {
    const card = document.createElement('div');
    card.className = 'blend-card';
    card.textContent = blend;
    card.onclick = () => addToBuild(blend);
    blendGrid.appendChild(card);
  });
  const letterGrid = document.getElementById('letterGrid');
  letterGrid.innerHTML = '';
  letters.forEach(letter => {
    const card = document.createElement('div');
    card.className = 'letter-card';
    card.textContent = letter;
    card.onclick = () => addToBuild(letter);
    letterGrid.appendChild(card);
  });
}
function addToBuild(part) {
  if (challengeActive) {
    addToBuildChallenge(part);
    return;
  }
  if (currentBuild.length >= 5) return;
  currentBuild += part;
  document.getElementById('buildWord').textContent = currentBuild;
  playSoundAnimated(currentBuild);
  checkBuild();
}
function playSoundAnimated(word) {
  if ('speechSynthesis' in window) {
    let parts = splitWord(word);
    let el = document.getElementById('buildWord');
    if (parts.length === 2) {
      // Highlight first part
      el.innerHTML = `<span style='background:#ffd60a;color:#2d6a4f;border-radius:0.5rem;padding:0.2rem;'>${parts[0]}</span><span style='background:#e0f7fa;color:#ff4066;border-radius:0.5rem;padding:0.2rem;'>${parts[1]}</span>`;
      let utter1 = new SpeechSynthesisUtterance(parts[0]);
      utter1.lang = 'en-US';
      utter1.pitch = 1.4;
      utter1.rate = 0.8;
      let utter2 = new SpeechSynthesisUtterance(parts[1]);
      utter2.lang = 'en-US';
      utter2.pitch = 1.4;
      utter2.rate = 0.8;
      let utter3 = new SpeechSynthesisUtterance(word);
      utter3.lang = 'en-US';
      utter3.pitch = 1.2;
      utter3.rate = 1.0;
      utter1.onend = function() {
        el.innerHTML = `<span style='background:#e0f7fa;color:#ff4066;border-radius:0.5rem;padding:0.2rem;'>${parts[0]}</span><span style='background:#ffd60a;color:#2d6a4f;border-radius:0.5rem;padding:0.2rem;'>${parts[1]}</span>`;
        window.speechSynthesis.speak(utter2);
      };
      utter2.onend = function() {
        el.innerHTML = `<span style='background:#ffd60a;color:#2d6a4f;border-radius:0.5rem;padding:0.2rem;'>${parts[0]}</span><span style='background:#ffd60a;color:#2d6a4f;border-radius:0.5rem;padding:0.2rem;'>${parts[1]}</span> = <span style='background:#e0f7fa;color:#ff4066;border-radius:0.5rem;padding:0.2rem;'>${word}</span>`;
        window.speechSynthesis.speak(utter3);
      };
      utter3.onend = function() {
        el.innerHTML = word;
      };
      window.speechSynthesis.speak(utter1);
    } else {
      el.textContent = word;
      let utter = new SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      utter.pitch = 1.2;
      utter.rate = 1.0;
      window.speechSynthesis.speak(utter);
    }
  }
}
function checkBuild() {
  const feedback = document.getElementById('buildFeedback');
  const img = document.getElementById('buildImg');
  if (words[currentBuild]) {
    feedback.textContent = 'Great job! You built "' + currentBuild + '"!';
    img.src = words[currentBuild].img;
    img.style.display = 'block';
    showConfetti();
    updateStreak(streak+1);
    reviewWords.push({word: currentBuild, parts: splitWord(currentBuild)});
    updateReview();
    showMascotFeedback(mascotPhrases[Math.floor(Math.random()*mascotPhrases.length)]);
    setTimeout(() => {
      currentBuild = '';
      document.getElementById('buildWord').textContent = '';
      img.style.display = 'none';
      feedback.textContent = '';
      showHint('');
    }, 2200);
  } else if (currentBuild.length >= 3) {
    feedback.textContent = 'Try another blend or letter!';
    img.style.display = 'none';
    showMascotFeedback('Try sounding out each part!');
    showHint('Hint: Try a different starting letter or blend.');
    updateStreak(0);
  } else {
    feedback.textContent = '';
    img.style.display = 'none';
    showHint('');
  }
}
function splitWord(word) {
  // Simple split for review, e.g. 'cat' => ['c','at']
  for (let i=1; i<word.length; i++) {
    let part1 = word.slice(0,i);
    let part2 = word.slice(i);
    if (blends.includes(part2) && letters.includes(part1)) return [part1, part2];
  }
  return [word];
}
function showConfetti() {
  var confetti = document.createElement('span');
  confetti.className = 'confetti';
  confetti.innerHTML = 'üéâ';
  document.body.appendChild(confetti);
  setTimeout(function(){ confetti.remove(); }, 1200);
}
function startChallenge() {
  challengeActive = true;
  challengeScore = 0;
  challengeTimer = 60;
  document.getElementById('challengeScore').textContent = 'Score: 0';
  document.getElementById('challengeTimer').textContent = 'Time: 60s';
  currentBuild = '';
  let interval = setInterval(() => {
    challengeTimer--;
    document.getElementById('challengeTimer').textContent = 'Time: ' + challengeTimer + 's';
    if (challengeTimer <= 0) {
      clearInterval(interval);
      challengeActive = false;
      document.getElementById('challengeScore').textContent = 'Final Score: ' + challengeScore;
      showMascotFeedback('Challenge complete!');
    }
  }, 1000);
}
function addToBuildChallenge(part) {
  if (currentBuild.length >= 5) return;
  currentBuild += part;
  document.getElementById('buildWord').textContent = currentBuild;
  playSoundAnimated(currentBuild);
  if (words[currentBuild]) {
    challengeScore++;
    document.getElementById('challengeScore').textContent = 'Score: ' + challengeScore;
    showConfetti();
    reviewWords.push({word: currentBuild, parts: splitWord(currentBuild)});
    updateReview();
    setTimeout(() => {
      currentBuild = '';
      document.getElementById('buildWord').textContent = '';
    }, 1200);
  }
}
function resetPractice() {
  currentBuild = '';
  document.getElementById('buildWord').textContent = '';
  document.getElementById('buildImg').style.display = 'none';
  document.getElementById('buildFeedback').textContent = '';
  showHint('');
}
showGuidedBlending();
renderCards();
updateStreak(0);
updateProgress(0);
</script>
{% endblock %}
