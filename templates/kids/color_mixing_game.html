{% extends 'base.html' %}
{% block content %}
<div id="game-root" class="color-game-root">
    <div id="badges-container" style="margin-bottom:16px; text-align:center;"></div>
    <div id="leaderboard-container" style="margin-bottom:16px; text-align:center; display:none;"></div>
    <div style="display:flex; justify-content:center; gap:12px; margin-bottom:16px;">
        <!-- Removed game-btn-row with mode buttons -->
    </div>
    <div id="start-screen" class="game-screen">
    <h1 class="game-title">Color Mixing Challenge</h1>
    <p class="game-desc">Can you mix the right colors to match the target?</p>
    <button id="start-btn" class="game-btn">Start Game</button>
    <button id="view-leaderboard-btn" class="game-btn game-btn-secondary" style="margin-top:8px;">View Leaderboard</button>
    </div>
    <div id="play-screen" class="game-screen" style="display:none;">
        <div class="score-level">
            <span>Level: <span id="level">1</span></span>
            <span>Score: <span id="score">0</span></span>
            <span>Time: <span id="timer">20</span>s</span>
            <button id="sound-toggle" class="game-btn game-btn-secondary" style="padding:2px 12px; font-size:1em;">🔊</button>
        </div>
        <div class="progress-bar-bg"><div id="progress-bar" class="progress-bar"></div></div>
            <div class="target-color-block">
                <span>Target Color:</span>
                <div id="target-color" class="color-block"></div>
                <div id="target-color-name" class="color-name" style="font-size:1.2em; font-weight:bold; color:#d90429; margin-top:8px;"></div>
                <button id="hint-btn" class="game-btn game-btn-secondary" style="margin-top:10px;">Hint</button>
            </div>
                <div class="palette-block">
                    <span>Choose Colors:</span>
                    <div class="palette" style="display:flex; flex-direction:column; gap:8px; align-items:center;">
                        <div style="display:flex; gap:24px; justify-content:center;">
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #ff0000;" data-color="red"></div>
                                <span style="color:#d90429;font-weight:bold; font-size:1em; margin-top:4px;">Red</span>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #0000ff;" data-color="blue"></div>
                                <span style="color:#005f73;font-weight:bold; font-size:1em; margin-top:4px;">Blue</span>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #ffff00;" data-color="yellow"></div>
                                <span style="color:#ffd60a;font-weight:bold; font-size:1em; margin-top:4px;">Yellow</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:24px; justify-content:center;">
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #ffffff; border: 3px solid #bbb;" data-color="white"></div>
                                <span style="color:#bbb;font-weight:bold; font-size:1em; margin-top:4px;">White</span>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #000000;" data-color="black"></div>
                                <span style="color:#23272f;font-weight:bold; font-size:1em; margin-top:4px;">Black</span>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #8B4513;" data-color="brown"></div>
                                <span style="color:#8B4513;font-weight:bold; font-size:1em; margin-top:4px;">Brown</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:24px; justify-content:center;">
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #008000;" data-color="green"></div>
                                <span style="color:#008000;font-weight:bold; font-size:1em; margin-top:4px;">Green</span>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div class="color-option" style="background: #ffa500;" data-color="orange"></div>
                                <span style="color:#ffa500;font-weight:bold; font-size:1em; margin-top:4px;">Orange</span>
                            </div>
                        </div>
                    </div>
                    <div id="selected-colors-names" class="color-name" style="font-size:1.1em; color:#005f73; margin:8px 0;"></div>
                    <button id="mix-btn" class="game-btn">Mix!</button>
                    <button id="reset-btn" class="game-btn game-btn-secondary">Reset</button>
                </div>
            <div class="result-block">
                <span>Your Mix:</span>
                <div id="mixed-color" class="color-block"></div>
                <div id="mixed-color-name" class="color-name" style="font-size:1.2em; font-weight:bold; color:#005f73; margin-top:8px;"></div>
                <div id="result-message" class="result-message"></div>
                <div id="fun-fact" class="fun-fact"></div>
            </div>
        <div id="confetti" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none;"></div>
    </div>
    <div id="end-screen" class="game-screen" style="display:none;">
        <h2 class="game-title">Game Over!</h2>
        <p class="game-desc">Your Score: <span id="final-score"></span></p>
        <button id="restart-btn" class="game-btn">Play Again</button>
    </div>
    <div style="text-align:center; margin-bottom:16px;">
        <!-- Remove End Game button from start screen and only show it in play screen -->
    </div>
</div>
<style>
body {
    background: linear-gradient(120deg, #fceabb 0%, #f8b500 100%);
    min-height: 100vh;
    animation: bgMove 10s linear infinite alternate;
}
@keyframes bgMove {
    0% { background-position: 0 0; }
    100% { background-position: 100vw 100vh; }
}
.color-game-root {
    max-width: 500px;
    margin: 40px auto;
    background: linear-gradient(135deg,#fffbe7 0%,#e0f7fa 100%);
    border-radius: 24px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.18);
    padding: 44px 28px;
    font-family: 'Baloo 2', 'Comic Sans MS', 'Comic Sans', cursive;
    position: relative;
    overflow: hidden;
}
.game-title {
    text-align: center;
    color: #ff9800;
    font-size: 2.6em;
    margin-bottom: 22px;
    font-weight: bold;
    letter-spacing: 2px;
    text-shadow: 2px 2px 0 #ffd60a, 0 4px 12px #ff980044;
    font-family: 'Luckiest Guy', 'Baloo 2', cursive;
}
.game-desc {
    text-align: center;
    color: #333;
    font-size: 1.3em;
    margin-bottom: 28px;
    font-family: 'Baloo 2', cursive;
}
.game-btn {
    background: linear-gradient(90deg,#ff9800 60%,#ffd60a 100%);
    color: #fff;
    border: none;
    border-radius: 14px;
    padding: 12px 36px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    margin: 14px 10px;
    box-shadow: 0 4px 16px #ffd60a44;
    transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
    animation: btnBounce 2s infinite alternate;
}
.game-btn:hover {
    background: linear-gradient(90deg,#ffd60a 60%,#ff9800 100%);
    transform: scale(1.08) rotate(-2deg);
    box-shadow: 0 8px 24px #ffd60a88;
}
@keyframes btnBounce {
    0% { transform: scale(1); }
    100% { transform: scale(1.04) rotate(-2deg); }
}
.game-btn-secondary {
    background: linear-gradient(90deg,#43c6ac 60%,#ffd60a 100%);
    color: #fff;
}
@media (max-width: 600px) {
    .color-game-root { max-width: 98vw; padding: 16px 4vw; margin: 12px auto; }
    .game-title { font-size: 1.6em; }
    .game-desc { font-size: 1.1em; }
    .game-btn { font-size: 1em; padding: 8px 18px; }
}
</style>
<style>
.color-game-root { max-width: 480px; margin: 40px auto; background: linear-gradient(135deg,#fffbe7 0%,#e0f7fa 100%); border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 36px 24px; font-family: 'Comic Sans MS', 'Comic Sans', cursive; }
.color-game-root { max-width: 480px; margin: 40px auto; background: linear-gradient(135deg,#fffbe7 0%,#e0f7fa 100%); border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 36px 24px; font-family: 'Comic Sans MS', 'Comic Sans', cursive; }
@media (max-width: 600px) {
    .color-game-root { max-width: 98vw; padding: 16px 4vw; margin: 12px auto; }
    .game-title { font-size: 1.4em; }
    .game-desc { font-size: 1em; }
    .color-block { width: 54px; height: 54px; }
    .palette { gap: 10px; }
    .color-option { width: 36px; height: 36px; }
    .result-message, .fun-fact { font-size: 1em; }
    .game-btn { font-size: 1em; padding: 8px 18px; }
    .score-level { font-size: 1em; }
    .progress-bar-bg { height: 8px; }
    #confetti span { font-size: 1.2rem !important; }
}
.game-title { text-align: center; color: #ff9800; font-size: 2.2em; margin-bottom: 18px; font-weight: bold; letter-spacing: 2px; }
.game-desc { text-align: center; color: #333; font-size: 1.2em; margin-bottom: 24px; }
.game-btn { background: #ff9800; color: #fff; border: none; border-radius: 10px; padding: 10px 32px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin: 12px 8px; box-shadow: 0 2px 8px #ffd60a44; transition: background 0.2s; }
.game-btn:hover { background: #e68900; }
.game-btn-secondary { background: #43c6ac; color: #fff; }
.score-level { display: flex; justify-content: space-between; font-size: 1.1em; margin-bottom: 18px; gap: 10px; align-items: center; }
.progress-bar-bg { width: 100%; height: 12px; background: #eee; border-radius: 8px; margin-bottom: 18px; }
.progress-bar { height: 100%; background: linear-gradient(90deg,#ff9800 60%,#43c6ac 100%); border-radius: 8px; width: 0%; transition: width 0.4s; }
.target-color-block, .palette-block, .result-block { margin-bottom: 22px; text-align: center; }
.color-block { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #333; margin: 0 auto; box-shadow: 0 2px 12px #43c6ac33; }
.palette { display: flex; justify-content: center; gap: 24px; margin: 18px 0; }
.color-option { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #333; cursor: pointer; transition: transform 0.2s, border 0.2s; }
.color-option.selected { border: 4px solid #ff9800; transform: scale(1.1); }
.result-message { margin-top: 16px; font-size: 1.15em; font-weight: bold; color: #d90429; min-height: 24px; }
.fun-fact { margin-top: 10px; font-size: 1em; color: #005f73; font-style: italic; min-height: 20px; }
.game-screen { animation: fadeInUp 0.8s; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
</style>
<style>
.game-btn-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 18px;
}
@media (max-width: 600px) {
    .game-btn-row {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
    }
    .game-btn-row .game-btn {
        width: 100%;
        margin: 0;
    }
}
</style>
<script>
// --- Feature: Progress Tracking, Badges, Leaderboard, Voice, Challenge, Review, Reset ---
let completedLevels = JSON.parse(localStorage.getItem('completedLevels') || '[]');
let topScores = JSON.parse(localStorage.getItem('topScores') || '[]');
function saveProgress() {
    localStorage.setItem('completedLevels', JSON.stringify(completedLevels));
    localStorage.setItem('topScores', JSON.stringify(topScores));
}
function showBadges() {
    let badges = [];
    if (completedLevels.length >= 5) badges.push('🏅 5 Levels');
    if (completedLevels.length >= 10) badges.push('🥈 10 Levels');
    if (completedLevels.length >= 25) badges.push('🥇 25 Levels');
    document.getElementById('badges-container').innerHTML = badges.length ? 'Badges: ' + badges.join(' ') : '';
}
function showLeaderboard() {
    let html = '<h3>Leaderboard</h3>';
    let sorted = [...topScores].sort((a,b)=>b.score-a.score).slice(0,5);
    if (sorted.length === 0) {
        html += '<div style="color:#d90429;font-weight:bold;font-size:1.1em;margin:12px 0;">No scores yet!<br>Finish the game to add your name and score.</div>';
    } else {
        html += '<ol>' + sorted.map(s=>`<li>${s.name||'Player'}: ${s.score}</li>`).join('') + '</ol>';
    }
    document.getElementById('leaderboard-container').innerHTML = html;
    document.getElementById('leaderboard-container').style.display = 'block';
}
function speak(text) {
    if ('speechSynthesis' in window) {
        let utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1;
        window.speechSynthesis.speak(utter);
    }
}
function shakeResult() {
    let el = document.getElementById('result-message');
    el.style.animation = 'shake 0.4s';
    el.addEventListener('animationend', ()=>{el.style.animation='';},{once:true});
}
const levels = [
    { target: 'purple', colors: ['red','blue'], hex: '#800080', fact: 'Purple is made by mixing red and blue. It is often seen in royal robes!' },
    { target: 'orange', colors: ['red','yellow'], hex: '#ffa500', fact: 'Orange is made by mixing red and yellow. It is the color of oranges and sunsets!' },
    { target: 'green', colors: ['blue','yellow'], hex: '#008000', fact: 'Green is made by mixing blue and yellow. It is the color of grass and leaves!' },
    { target: 'red', colors: ['red'], hex: '#ff0000', fact: 'Red is a primary color. It is the color of apples and fire trucks!' },
    { target: 'blue', colors: ['blue'], hex: '#0000ff', fact: 'Blue is a primary color. It is the color of the sky and the ocean!' },
    { target: 'yellow', colors: ['yellow'], hex: '#ffff00', fact: 'Yellow is a primary color. It is the color of bananas and sunshine!' },
    { target: 'brown', colors: ['red','yellow','blue'], hex: '#8B4513', fact: 'Brown is made by mixing all three primary colors. It is the color of tree bark!' },
    { target: 'pink', colors: ['red','white'], hex: '#ffc0cb', fact: 'Pink is made by mixing red and white. It is the color of flamingos!' },
    { target: 'light blue', colors: ['blue','white'], hex: '#add8e6', fact: 'Light blue is made by mixing blue and white. It is the color of a clear sky!' },
    { target: 'light green', colors: ['green','white'], hex: '#90ee90', fact: 'Light green is made by mixing green and white. It is the color of new leaves!' },
    { target: 'dark green', colors: ['green','black'], hex: '#006400', fact: 'Dark green is made by mixing green and black. It is the color of pine trees!' },
    { target: 'dark blue', colors: ['blue','black'], hex: '#00008b', fact: 'Dark blue is made by mixing blue and black. It is the color of the deep ocean!' },
    { target: 'gray', colors: ['black','white'], hex: '#808080', fact: 'Gray is made by mixing black and white. It is the color of clouds on a rainy day!' },
    { target: 'gold', colors: ['yellow','orange'], hex: '#ffd700', fact: 'Gold is made by mixing yellow and orange. It is the color of treasure!' },
    { target: 'teal', colors: ['blue','green'], hex: '#008080', fact: 'Teal is made by mixing blue and green. It is the color of tropical seas!' },
    { target: 'violet', colors: ['blue','purple'], hex: '#9400d3', fact: 'Violet is made by mixing blue and purple. It is the color of violets!' },
    { target: 'magenta', colors: ['red','purple'], hex: '#ff00ff', fact: 'Magenta is made by mixing red and purple. It is the color of some flowers!' },
    { target: 'lime', colors: ['yellow','green'], hex: '#bfff00', fact: 'Lime is made by mixing yellow and green. It is the color of limes!' },
    { target: 'peach', colors: ['orange','white'], hex: '#ffe5b4', fact: 'Peach is made by mixing orange and white. It is the color of peaches!' },
    { target: 'navy', colors: ['blue','black'], hex: '#000080', fact: 'Navy is made by mixing blue and black. It is the color of navy uniforms!' },
    { target: 'maroon', colors: ['red','black'], hex: '#800000', fact: 'Maroon is made by mixing red and black. It is the color of autumn leaves!' },
    { target: 'olive', colors: ['yellow','black'], hex: '#808000', fact: 'Olive is made by mixing yellow and black. It is the color of olives!' },
    { target: 'sky blue', colors: ['blue','white'], hex: '#87ceeb', fact: 'Sky blue is made by mixing blue and white. It is the color of the sky on a sunny day!' },
    { target: 'beige', colors: ['brown','white'], hex: '#f5f5dc', fact: 'Beige is made by mixing brown and white. It is the color of sand!' },
    { target: 'turquoise', colors: ['blue','green','white'], hex: '#40e0d0', fact: 'Turquoise is made by mixing blue, green, and white. It is the color of tropical waters!' }
];
let currentLevel = 0;
let score = 0;
let usedHint = false;
let selectedColors = [];
let timer = null;
let timeLeft = 20;
let muted = false;
function showScreen(id) {
    document.querySelectorAll('.game-screen').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
}
function setLevel(levelIdx) {
    currentLevel = levelIdx;
    document.getElementById('level').textContent = levelIdx+1;
    document.getElementById('score').textContent = score;
    document.getElementById('target-color').style.background = levels[levelIdx].hex;
    document.getElementById('target-color-name').textContent = levels[levelIdx].target.charAt(0).toUpperCase() + levels[levelIdx].target.slice(1);
    document.getElementById('mixed-color').style.background = '#fff';
    document.getElementById('mixed-color-name').textContent = '';
    document.getElementById('result-message').textContent = '';
    document.getElementById('fun-fact').textContent = '';
    document.getElementById('selected-colors-names').textContent = '';
    selectedColors = [];
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    document.getElementById('progress-bar').style.width = ((levelIdx+1)/levels.length*100)+'%';
    usedHint = false;
    startTimer();
}
function startTimer() {
    clearInterval(timer);
    timeLeft = 20;
    document.getElementById('timer').textContent = timeLeft;
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timer);
            score -= 5;
            document.getElementById('result-message').textContent = 'Time up!';
            playSound('fail');
            setTimeout(() => {
                if (currentLevel < levels.length-1) {
                    setLevel(currentLevel+1);
                } else {
                    document.getElementById('final-score').textContent = score;
                    showScreen('end-screen');
                }
            }, 1200);
        }
    }, 1000);
}
document.getElementById('start-btn').onclick = function() {
    window.location.href = '/kids/play-screen/';
};
document.getElementById('view-leaderboard-btn').onclick = function() {
    window.location.href = '/kids/leaderboard/';
};
document.getElementById('restart-btn').onclick = function() {
    score = 0;
    setLevel(0);
    showScreen('play-screen');
};
document.querySelectorAll('.color-option').forEach(opt => {
    opt.onclick = function() {
        if (selectedColors.length < 3 && !selectedColors.includes(opt.dataset.color)) {
            selectedColors.push(opt.dataset.color);
            opt.classList.add('selected');
        }
        // Show selected color names
        if (selectedColors.length > 0) {
            document.getElementById('selected-colors-names').textContent = 'Selected: ' + selectedColors.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(' + ');
        } else {
            document.getElementById('selected-colors-names').textContent = '';
        }
    };
});
document.getElementById('reset-btn').onclick = function() {
    selectedColors = [];
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    document.getElementById('mixed-color').style.background = '#fff';
    document.getElementById('mixed-color-name').textContent = '';
    document.getElementById('selected-colors-names').textContent = '';
    document.getElementById('result-message').textContent = '';
    document.getElementById('fun-fact').textContent = '';
};
document.getElementById('mix-btn').onclick = function() {
    let arr = window.shuffledLevels || levels;
    var level = arr[currentLevel];
    if (selectedColors.length === 0) {
        document.getElementById('result-message').textContent = 'Pick at least one color!';
        document.getElementById('mixed-color-name').textContent = '';
        return;
    }
    let result = { color: 'unknown', hex: '#fff' };
    // Find a matching level.colors set
    for (let lvl of levels) {
        // Compare arrays regardless of order
        if (lvl.colors.length === selectedColors.length && lvl.colors.every(c => selectedColors.includes(c)) && selectedColors.every(c => lvl.colors.includes(c))) {
            result = { color: lvl.target, hex: lvl.hex };
            break;
        }
    }
    // Fallback for single color
    if (result.color === 'unknown' && selectedColors.length === 1) {
        if (selectedColors[0] === 'red') result = { color: 'red', hex: '#ff0000' };
        if (selectedColors[0] === 'blue') result = { color: 'blue', hex: '#0000ff' };
        if (selectedColors[0] === 'yellow') result = { color: 'yellow', hex: '#ffff00' };
    }
    document.getElementById('mixed-color').style.background = result.hex;
    document.getElementById('mixed-color-name').textContent = result.color.charAt(0).toUpperCase() + result.color.slice(1);
    speak('You mixed ' + selectedColors.join(' and ') + '. Result: ' + result.color);
    if (result.color === level.target) {
        let baseScore = timeLeft * 1; // 1 point per second left
        if (usedHint) {
            baseScore = Math.floor(baseScore / 2);
        }
        score += baseScore;
        document.getElementById('result-message').textContent = 'Correct! 🎉';
        document.getElementById('fun-fact').textContent = level.fact;
        speak(level.target + '. ' + level.fact);
        playSound('success');
        showConfetti();
        clearInterval(timer);
        if (!completedLevels.includes(currentLevel)) completedLevels.push(currentLevel);
        saveProgress();
        showBadges();
        setTimeout(() => {
            hideConfetti();
            if (currentLevel < arr.length-1) {
                setLevel(currentLevel+1);
            } else {
                document.getElementById('final-score').textContent = score;
                topScores.push({score, name: playerName});
                saveProgress();
                showLeaderboard();
                showScreen('end-screen');
            }
        }, 1500);
    } else {
        score -= 3;
        document.getElementById('result-message').textContent = 'Try again!';
        shakeResult();
        playSound('fail');
    }
    document.getElementById('score').textContent = score;
};
    
// Challenge Mode
document.getElementById('challenge-mode-btn').onclick = function() {
    let idx = Math.floor(Math.random()*levels.length);
    setLevel(idx);
    showScreen('play-screen');
};

// Review Mode
document.getElementById('review-mode-btn').onclick = function() {
    let html = '<h4>Review Completed Levels</h4><ul style="padding-left:0;">';
    for (let idx of completedLevels) {
        let lvl = levels[idx];
        // Find the most recent history entry for this level
        let hist = mixHistory.filter(h => h.level === idx+1).slice(-1)[0];
        let mixed = hist ? hist.selected.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(' + ') : 'N/A';
        let result = hist ? hist.result.charAt(0).toUpperCase() + hist.result.slice(1) : 'N/A';
        // Find score for this level if available
        let scoreEntry = topScores.find(s => s.level === idx+1);
        let scoreText = scoreEntry ? `Score: ${scoreEntry.score}` : '';
        html += `<li style="margin-bottom:12px;list-style:none;padding:12px;background:#e0f7fa;border-radius:8px;">
            <strong>Level ${idx+1}: ${lvl.target.charAt(0).toUpperCase() + lvl.target.slice(1)}</strong><br>
            <span style="color:#005f73;">Mixed: ${mixed}</span><br>
            <span style="color:#ff9800;">Result: ${result}</span><br>
            <span style="font-style:italic;">${lvl.fact}</span><br>
            <span style="color:#43c6ac;">${scoreText}</span>
        </li>`;
    }
    html += '</ul>';
    document.getElementById('history-container').innerHTML = html;
    document.getElementById('history-container').style.display = 'block';
};

// Reset Progress
document.getElementById('reset-progress-btn').onclick = function() {
    if (confirm('Reset all progress?')) {
        completedLevels = [];
        topScores = [];
        mixHistory = [];
        saveProgress();
        showBadges();
        document.getElementById('leaderboard-container').style.display = 'none';
        document.getElementById('history-container').style.display = 'none';
        alert('Progress reset!');
    }
};

// Use Django username from template
var playerName = "{{ username|escapejs }}";
window.onload = function() {
    if (!playerName) {
        showNameModal();
    } else {
        hideNameModal();
    }
    showBadges();
    showLeaderboard();
};
// On load
window.onload = function() {
    showBadges();
    showLeaderboard();
};
// Show Leaderboard Button
document.getElementById('leaderboard-btn').onclick = function() {
    window.location.href = '/kids/leaderboard/';
};
// --- Animated shake effect ---
let style = document.createElement('style');
style.innerHTML = '@keyframes shake {0%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-8px);}80%{transform:translateX(8px);}100%{transform:translateX(0);}}';
document.head.appendChild(style);
document.getElementById('hint-btn').onclick = function() {
    const level = levels[currentLevel];
    document.getElementById('result-message').textContent = 'Hint: Mix ' + level.colors.join(' + ');
    playSound('hint');
    usedHint = true;
};
document.getElementById('sound-toggle').onclick = function() {
    muted = !muted;
    this.textContent = muted ? '🔇' : '🔊';
};
function playSound(type) {
    if (muted) return;
    let audio;
    if (type === 'success') audio = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b6c7b7b.mp3');
    else if (type === 'fail') audio = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b6c7b7b.mp3');
    else if (type === 'hint') audio = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b6c7b7b.mp3');
    audio.volume = 0.3;
    audio.play();
}
function showConfetti() {
    const confetti = document.getElementById('confetti');
    confetti.innerHTML = '';
    confetti.style.display = 'block';
    for (let i = 0; i < 40; i++) {
        let span = document.createElement('span');
        span.innerHTML = '&#127882;';
        span.style.left = Math.random() * 100 + '%';
        span.style.top = Math.random() * 80 + '%';
        span.style.color = ['#ffd60a','#d90429','#43c6ac','#005f73','#fff9c4'][i%5];
        span.style.position = 'absolute';
        span.style.fontSize = (Math.random()*1.5+1)+'rem';
        confetti.appendChild(span);
    }
    setTimeout(hideConfetti, 1200);
}
function hideConfetti() {
    document.getElementById('confetti').style.display = 'none';
}
document.getElementById('end-game-btn').onclick = function() {
    clearInterval(timer); // Stop the timer
    showScreen('end-screen'); // Only show end screen
    document.getElementById('final-score').textContent = score;
    topScores.push({score, name: playerName});
    saveProgress();
    showLeaderboard();
};
</script>
{% endblock %}
