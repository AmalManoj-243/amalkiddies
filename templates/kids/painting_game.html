// Color Picker Tool Logic
function pickColor(e) {
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  const pixel = ctx.getImageData(x, y, 1, 1).data;
  if (pixel[3] === 0) return;
  const rgb = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
  brushColor = rgb;
  document.querySelectorAll('.color-swatch').forEach(s => {
    if (s.style.background === rgb) {
      s.classList.add('selected');
    } else {
      s.classList.remove('selected');
    }
  });
}

let drawing = false, tool = 'brush', brushSize = 12, brushColor = '#000000', rectStart = null;
canvas.addEventListener('mousedown', function(e) {
  if(tool==='brush' || tool==='eraser') {
    drawing = true;
    draw(e);
    saveState();
  } else if(tool==='fill') {
    const {x, y} = getXY(e);
    floodFill(x, y, brushColor);
    saveState();
  } else if(tool==='picker') {
    pickColor(e);
  } else if(tool==='rect') {
    rectStart = getXY(e);
  }
});
canvas.addEventListener('mousemove', function(e) {
  if(drawing && (tool==='brush' || tool==='eraser')) {
    draw(e);
  }
});
canvas.addEventListener('mouseup', function(e) {
  if(drawing && (tool==='brush' || tool==='eraser')) {
    drawing = false;
    ctx.beginPath();
  } else if(tool==='rect' && rectStart) {
    const rectEnd = getXY(e);
    ctx.strokeStyle = brushColor;
    ctx.lineWidth = brushSize;
    ctx.strokeRect(rectStart.x, rectStart.y, rectEnd.x-rectStart.x, rectEnd.y-rectStart.y);
    rectStart = null;
    saveState();
  }
});
{% extends "kids/base.html" %}
{% block content %}
<style>
  html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #181818; }
  .paint-toolbar { position: fixed; top: 0; left: 0; width: 100vw; height: auto; background: #f8f9fa; border-bottom: 2px solid #00b8ff; box-shadow: 0 2px 8px #00b8ff22; display: flex; flex-direction: row; flex-wrap: wrap; align-items: center; z-index: 10; padding: 0 8px; gap: 6px; justify-content: flex-start; }
  .paint-toolbar .tool-btn, .paint-toolbar .paint-btn { background: #fff; color: #00b8ff; border: 1px solid #00b8ff; padding: 2px 6px; border-radius: 7px; font-size: 0.85rem; margin: 0 1px; cursor: pointer; transition: 0.2s; }
  .paint-toolbar i { font-size: 1rem; }
  .paint-toolbar .tool-btn.active, .paint-toolbar .paint-btn.active { background: #00b8ff; color: #fff; }
  .paint-toolbar .paint-btn.save { background: #00b8ff; color: #fff; }
  .paint-toolbar .color-palette { display: flex; gap: 6px; margin-left: 8px; }
  .paint-toolbar .color-swatch { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #00b8ff; cursor: pointer; transition: 0.2s; }
  .paint-toolbar .color-swatch.selected { border: 3px solid #00b8ff; box-shadow: 0 0 8px #00b8ff88; }
  .mode-select-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
    z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
    animation: popIn 0.7s cubic-bezier(.4,2,.3,1);
  }
  @keyframes popIn {
    0% { transform: scale(0.7); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  .mode-select-modal h2 {
    color: #ff4066;
    font-size: 2.6rem;
    margin-bottom: 32px;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    text-shadow: 2px 2px 0 #fff, 0 0 12px #43c6ac;
    letter-spacing: 2px;
    animation: bounce 1.2s infinite alternate;
  }
  @keyframes bounce {
    0% { transform: translateY(0); }
    100% { transform: translateY(-12px); }
  }
  .mode-select-modal .mode-btns {
    display: flex;
    gap: 32px;
    flex-direction: row;
    justify-content: center;
    flex-wrap: wrap;
  }
  .mode-select-modal .mode-btn {
    font-size: 2.1rem;
    padding: 28px 48px;
    border-radius: 32px;
    border: none;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    box-shadow: 0 4px 24px #43c6ac88, 0 0 0 8px #fff8dc;
    cursor: pointer;
    transition: 0.2s;
    margin: 12px 0;
    position: relative;
    font-weight: bold;
    outline: none;
    border: 3px solid #ff4066;
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #43c6ac;
    text-shadow: 1px 1px 0 #fff, 0 0 8px #ff4066;
  }
  .mode-select-modal .mode-btn.level {
    border-color: #ff4066;
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #43c6ac;
  }
  .mode-select-modal .mode-btn.paint {
    border-color: #43c6ac;
    background: linear-gradient(135deg, #43c6ac 0%, #f8ffae 100%);
    color: #ff4066;
  }
  .mode-select-modal .mode-btn:hover {
    transform: scale(1.12) rotate(-2deg);
    box-shadow: 0 8px 32px #ff406688, 0 0 0 12px #fff8dc;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
  }
  @media (max-width: 767px) {
    .mode-select-modal h2 { font-size: 2.1rem; margin-bottom: 18px; }
    .mode-select-modal .mode-btn { font-size: 1.4rem; padding: 18px 18px; border-radius: 22px; margin: 8px 0; }
    .mode-select-modal .mode-btns { gap: 18px; }
  }
  .level-chooser {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
    color: #ff4066; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    padding: 0;
    border-radius: 0;
    box-shadow: none;
    font-size: 2.2rem; z-index: 9999; display: none;
    animation: popIn 0.7s cubic-bezier(.4,2,.3,1);
    max-width: 100vw;
    overflow-y: auto;
  }
  .level-chooser .paint-btn {
    background: linear-gradient(135deg, #43c6ac 0%, #f8ffae 100%);
    color: #ff4066;
    border: 2px solid #ff4066;
    border-radius: 18px;
    font-size: 1.3rem;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    padding: 12px 32px;
    margin-top: 18px;
    font-weight: bold;
    box-shadow: 0 2px 12px #43c6ac44;
    cursor: pointer;
    transition: 0.2s;
    outline: none;
    animation: bounceBack 1.2s infinite alternate;
  }
    .level-chooser .paint-btn:hover {
      background: linear-gradient(135deg, #ff4066 0%, #f8ffae 100%);
      color: #43c6ac;
      border-color: #43c6ac;
      transform: scale(1.08) rotate(-2deg);
      box-shadow: 0 8px 24px #ff406688;
      animation: shakeBtn 0.4s;
    }
  @keyframes bounceBack {
    0% { transform: translateY(0); }
    100% { transform: translateY(-6px); }
  }
  .level-chooser h3 {
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    color: #ff4066;
    font-size: 3rem;
    margin-bottom: 28px;
    text-shadow: 2px 2px 0 #fff, 0 0 12px #43c6ac;
    letter-spacing: 2px;
    animation: bounce 1.2s infinite alternate;
  }
  .level-chooser .level-btns {
    display: flex; flex-wrap: wrap; gap: 38px; justify-content: center; margin-bottom: 32px;
  }
  .level-chooser .level-btn {
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #43c6ac;
    border: 3px solid #ff4066;
    border-radius: 22px;
    font-size: 1.4rem;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    padding: 10px 24px;
    min-width: 120px; min-height: 32px;
    box-shadow: 0 4px 16px #43c6ac88, 0 0 0 6px #fff8dc;
    cursor: pointer; display: flex; align-items: center; gap: 14px; transition: 0.2s;
    font-weight: bold;
    outline: none;
    margin: 10px 0;
    position: relative;
    text-shadow: 1px 1px 0 #fff, 0 0 8px #ff4066;
    animation: bounceBtn 1.2s infinite alternate;
  }
  @keyframes bounceBtn {
    0% { transform: translateY(0); }
    100% { transform: translateY(-8px) scale(1.05); }
  }
  .level-chooser .level-btn:hover {
  background: linear-gradient(135deg, #ff4066 0%, #f8ffae 100%);
  color: #fff;
  transform: scale(1.15) rotate(-4deg);
  box-shadow: 0 16px 40px #ff406688, 0 0 0 18px #fff8dc;
  border-color: #43c6ac;
  text-shadow: 2px 2px 0 #43c6ac, 0 0 12px #ff4066;
  filter: brightness(1.15) drop-shadow(0 4px 12px #43c6ac88);
  animation: shakeBtn 0.4s;
}
@keyframes shakeBtn {
  0% { transform: scale(1.15) rotate(-4deg) translateX(0); }
  25% { transform: scale(1.15) rotate(-4deg) translateX(-4px); }
  50% { transform: scale(1.15) rotate(-4deg) translateX(4px); }
  75% { transform: scale(1.15) rotate(-4deg) translateX(-2px); }
  100% { transform: scale(1.15) rotate(-4deg) translateX(0); }
}
  .level-chooser .level-btn span {
    font-size: 1.8rem;
    margin-right: 8px;
    filter: drop-shadow(0 2px 4px #43c6ac88);
    animation: bounceIcon 1.2s infinite alternate;
  }
  @keyframes bounceIcon {
    0% { transform: translateY(0); }
    100% { transform: translateY(-6px); }
  }
  @media (max-width: 767px) {
    .level-chooser {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      font-size: 1.6rem; padding: 0; border-radius: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
      box-shadow: none;
      z-index: 9999;
    }
    .level-chooser h3 { font-size: 2.2rem; margin-bottom: 18px; }
    .level-chooser .level-btn { font-size: 1.6rem; padding: 28px 18px; border-radius: 22px; min-width: 160px; min-height: 60px; }
    .level-chooser .level-btn span { font-size: 2.2rem; }
    .level-chooser .level-btns { gap: 18px; }
  }
  .import-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
    z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; display: none;
    animation: popIn 0.7s cubic-bezier(.4,2,.3,1);
  }
  .import-modal .import-box {
  @media (max-width: 767px) {
    .import-modal {
      padding: 0;
      align-items: center;
      justify-content: center;
    overflow-y: auto;
    }
    .import-modal .import-box {
      width: auto;
      max-width: 92vw;
      min-width: 0;
      padding: 18px 0;
      border-radius: 18px;
      font-size: 1.1rem;
      box-sizing: border-box;
      margin-left: 4vw;
      margin-right: 4vw;
    margin-top: 8vh;
    margin-bottom: 8vh;
    max-height: 84vh;
    overflow-y: auto;
    }
    .import-modal .import-box h3 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    .import-modal input[type='file'] {
      font-size: 1rem;
      padding: 6px 8px;
    }
    .import-modal .import-btn {
      font-size: 1.1rem;
      padding: 10px 18px;
      border-radius: 12px;
    }
  }
    background: linear-gradient(135deg, #fff8dc 0%, #f8ffae 100%);
    color: #ff4066;
    padding: 38px 54px;
    border-radius: 28px;
    box-shadow: 0 4px 24px #43c6ac88, 0 0 0 8px #fff8dc;
    font-size: 1.6rem;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    text-align: center;
    animation: bounce 1.2s infinite alternate;
  }
  .import-modal .import-box h3 {
    color: #ff4066;
    font-size: 2.2rem;
    margin-bottom: 18px;
    text-shadow: 2px 2px 0 #fff, 0 0 12px #43c6ac;
    letter-spacing: 2px;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    animation: bounce 1.2s infinite alternate;
  }
  .import-modal input[type='file'] {
    margin-top: 18px;
    font-size: 1.2rem;
    border-radius: 12px;
    border: 2px solid #43c6ac;
    padding: 8px 12px;
    background: #fff8dc;
    color: #ff4066;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    box-shadow: 0 2px 8px #43c6ac44;
    transition: 0.2s;
  }
  .import-modal input[type='file']:hover {
    background: #f8ffae;
    border-color: #ff4066;
    color: #43c6ac;
  }
  .import-modal .import-btn {
    margin-top: 22px;
    background: linear-gradient(135deg, #43c6ac 0%, #f8ffae 100%);
    color: #ff4066;
    border: 2px solid #ff4066;
    border-radius: 18px;
    font-size: 1.4rem;
    padding: 14px 32px;
    cursor: pointer;
    font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
    font-weight: bold;
    box-shadow: 0 2px 12px #43c6ac44;
    transition: 0.2s;
    outline: none;
    animation: bounceBtn 1.2s infinite alternate;
  }
  .import-modal .import-btn:hover {
    background: linear-gradient(135deg, #ff4066 0%, #f8ffae 100%);
    color: #43c6ac;
    border-color: #43c6ac;
    transform: scale(1.08) rotate(-2deg);
    box-shadow: 0 8px 24px #ff406688;
    animation: shakeBtn 0.4s;
  }
  .canvas-container { position: absolute; top: 80px; left: 0; width: 100vw; height: calc(100vh - 80px); overflow: auto; background: #fff; z-index: 1; display: flex; align-items: center; justify-content: center; }
  #paintCanvas { display: block; cursor: crosshair; background: #fff; transition: transform 0.2s cubic-bezier(.4,2,.3,1); }
</style>
@media (max-width: 1200px) { .paint-toolbar { gap: 2px; padding: 0 1px; } .tool-btn, .paint-btn { min-width: 18px; font-size: 0.8rem; padding: 1px 2px; } .paint-toolbar i { font-size: 0.85rem; } }
@media (max-width: 767px) {
  .paint-toolbar { font-size: 0.7rem; padding: 0 0.5px; gap: 1px; flex-wrap: wrap; }
  .tool-btn, .paint-btn { min-width: 14px; font-size: 0.7rem; padding: 1px 1px; }
  .paint-toolbar i { font-size: 0.7rem; }
  .canvas-container { width: 100vw !important; height: calc(100vh - 80px) !important; }
}
<div class="paint-toolbar">
  <button onclick="setTool('brush')" id="brushBtn" class="tool-btn active" title="Brush"><i class="fas fa-paint-brush"></i></button>
  <button onclick="setTool('fill')" id="fillBtn" class="tool-btn" title="Fill"><i class="fas fa-fill-drip"></i></button>
  <button onclick="setTool('eraser')" id="eraserBtn" class="tool-btn" title="Eraser"><i class="fas fa-eraser"></i></button>
  <button onclick="setTool('picker')" id="pickerBtn" class="tool-btn" title="Color Picker"><i class="fas fa-eye-dropper"></i></button>
  <button onclick="setTool('circle')" id="circleBtn" class="tool-btn" title="Circle Tool"><i class="fas fa-circle"></i></button>
  <button onclick="setTool('line')" id="lineBtn" class="tool-btn" title="Line Tool"><i class="fas fa-slash"></i></button>
  <button onclick="setTool('text')" id="textBtn" class="tool-btn" title="Text Tool"><i class="fas fa-font"></i></button>
  <button onclick="zoomIn()" class="tool-btn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
  <button onclick="zoomOut()" class="tool-btn" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
  <label style="margin:0 8px;white-space:nowrap;">Brush Size: <input type="range" id="brushSize" min="2" max="64" value="12" style="vertical-align:middle;"></label>
  <label style="margin:0 8px;white-space:nowrap;">Brush Color: <input type="color" id="brushColorInput" value="#000000" style="vertical-align:middle;"></label>
  <button onclick="undo()" class="paint-btn" title="Undo"><i class="fas fa-undo"></i></button>
  <button onclick="redo()" class="paint-btn" title="Redo"><i class="fas fa-redo"></i></button>
  <button onclick="clearCanvas()" class="paint-btn" title="Clear"><i class="fas fa-trash"></i></button>
  <button onclick="savePainting()" class="paint-btn save" title="Save"><i class="fas fa-save"></i></button>
  <button onclick="showImportModal()" class="paint-btn" title="Import Drawing"><i class="fas fa-file-import"></i> Import</button>
  <span id="saveMsg" style="color:#00b8ff;font-weight:600;margin-left:12px;"></span>
  <div id="levelSampleImg" style="position:fixed;top:170px;left:23px;z-index:9998;display:none;"></div>
  </div>
  <!-- Removed duplicate apple reference image container for cleaner layout -->
</div>
<div id="appleRefImgContainer" style="width:100vw; text-align:left; margin:0; padding-left:18px; margin-top:18px;">
  <div id="appleRefLabel" style="font-size:1rem;color:#00b8ff;font-weight:600;margin-bottom:4px;display:none;">Apple Reference Image:</div>
  <img id="appleRefImg" src="/media/movies/apple-439397_640.webp" alt="Apple Reference" style="max-width:120px;max-height:120px;border-radius:12px;box-shadow:0 2px 12px #00b8ff44;background:#fff;display:none;vertical-align:top;border:2px dashed #ff4066;">
</div>
<div class="canvas-container"><canvas id="paintCanvas" width="1920" height="1080"></canvas></div>
<div id="modeSelect" class="mode-select-modal">
  <h2>🎉 Choose Your Fun Mode! 🎉</h2>
  <div class="mode-btns">
    <button onclick="startLevelMode()" class="mode-btn level">
      <span style="font-size:2.5rem;">🎨</span><br>Coloring Levels<br><span style="font-size:1.2rem;">(Fill colors in cool outlines!)</span>
    </button>
    <button onclick="startPaintMode()" class="mode-btn paint">
      <span style="font-size:2.5rem;">🖌️</span><br>Paint Your Drawing<br><span style="font-size:1.2rem;">(Draw anything you like!)</span>
    </button>
  </div>
</div>
<div id="levelChooser" class="level-chooser">
  <h3>Choose a Level</h3>
  <div id="levelBtns" class="level-btns"></div>
  <button onclick="backToModeSelect()" class="paint-btn">⬅️ Back</button>
</div>
<div id="importModal" class="import-modal">
  <div class="import-box">
    <h3>Import Your Drawing</h3>
    <input type="file" id="importFile" accept="image/png,image/jpeg">
    <button onclick="importDrawing()" class="import-btn">Import</button>
  </div>
</div>
<script>
// Mobile pinch-to-zoom support
// --- Autosave and Restore Logic ---
function autosavePainting() {
  try {
    localStorage.setItem('kids_painting_autosave', canvas.toDataURL());
  } catch (e) {}
}

function restorePainting() {
  const dataURL = localStorage.getItem('kids_painting_autosave');
  if (dataURL) {
    let img = new Image();
    img.src = dataURL;
    img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); };
  }
}

window.addEventListener('DOMContentLoaded', restorePainting);
let lastTouchDist = null;
const paintCanvas = document.getElementById('paintCanvas');
paintCanvas.addEventListener('touchstart', function(e) {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastTouchDist = Math.sqrt(dx*dx + dy*dy);
  }
});
paintCanvas.addEventListener('touchmove', function(e) {
  if (e.touches.length === 2) {
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (lastTouchDist) {
      if (dist > lastTouchDist + 10) { zoom *= 1.1; applyZoom(); }
      else if (dist < lastTouchDist - 10) { zoom /= 1.1; applyZoom(); }
    }
    lastTouchDist = dist;
  }
});
paintCanvas.addEventListener('touchend', function(e) { lastTouchDist = null; });
const canvas = document.getElementById('paintCanvas');
const ctx = canvas.getContext('2d');
function resizeCanvas() {
  // Responsive canvas: fit window, max 16:9, but allow full width on mobile
  let w = window.innerWidth;
  let h = window.innerHeight - 80;
  let aspect = 16/9;
  if (w < 600) {
    // On mobile, use full width and height
    canvas.width = w;
    canvas.height = h;
  } else {
    if (w/h > aspect) {
      h = Math.min(h, w/aspect);
      w = h * aspect;
    } else {
      w = Math.min(w, h*aspect);
      h = w / aspect;
    }
    canvas.width = w;
    canvas.height = h;
  }
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
let drawing = false, tool = 'brush', brushSize = 12, brushColor = '#000000', snapshot = null;
let history = [], redoStack = [];
let importedImage = null;
const paletteColors = [
  '#000000','#222222','#444444','#666666','#888888','#aaaaaa','#cccccc','#ffffff', // Grayscale
  '#ff0000','#ff4000','#ff8000','#ffbf00','#ffff00','#bfff00','#80ff00','#40ff00','#00ff00', // Reds/Oranges/Yellows/Greens
  '#00ff40','#00ff80','#00ffbf','#00ffff','#00bfff','#0080ff','#0040ff','#0000ff', // Blues
  '#4000ff','#8000ff','#bf00ff','#ff00ff','#ff00bf','#ff0080','#ff0040', // Purples/Pinks
  '#964B00','#FFD700','#C0C0C0','#A0522D','#8B4513','#D2691E','#F4A460','#DEB887','#FFF8DC' // Browns/Golds
];
function setTool(selected) {
  if(selected==='circle') document.getElementById('circleBtn').classList.add('active');
  if(selected==='line') document.getElementById('lineBtn').classList.add('active');
  if(selected==='text') document.getElementById('textBtn').classList.add('active');
// Circle Tool Logic
let circleStart = null;
canvas.addEventListener('mousedown', function(e) {
  if(tool==='circle') {
    circleStart = getXY(e);
  }
});
canvas.addEventListener('mouseup', function(e) {
  if(tool==='circle' && circleStart) {
    const circleEnd = getXY(e);
    const r = Math.sqrt(Math.pow(circleEnd.x-circleStart.x,2)+Math.pow(circleEnd.y-circleStart.y,2));
    ctx.strokeStyle = brushColor;
    ctx.lineWidth = brushSize;
    ctx.beginPath();
    ctx.arc(circleStart.x, circleStart.y, r, 0, 2*Math.PI);
    ctx.stroke();
    circleStart = null;
    saveState();
  }
});
// Line Tool Logic
let lineStart = null;
canvas.addEventListener('mousedown', function(e) {
  if(tool==='line') {
    lineStart = getXY(e);
  }
});
canvas.addEventListener('mouseup', function(e) {
  if(tool==='line' && lineStart) {
    const lineEnd = getXY(e);
    ctx.strokeStyle = brushColor;
    ctx.lineWidth = brushSize;
    ctx.beginPath();
    ctx.moveTo(lineStart.x, lineStart.y);
    ctx.lineTo(lineEnd.x, lineEnd.y);
    ctx.stroke();
    lineStart = null;
    saveState();
  }
});
// Text Tool Logic
canvas.addEventListener('mousedown', function(e) {
  if(tool==='text') {
    const {x, y} = getXY(e);
    const text = prompt('Enter text:');
    if(text) {
      ctx.font = `${brushSize*2}px Arial`;
      ctx.fillStyle = brushColor;
      ctx.fillText(text, x, y);
      saveState();
    }
  }
});
// Zoom Logic
let zoom = 1;
function zoomIn() {
  zoom = Math.min(zoom * 1.2, 10);
  requestAnimationFrame(applyZoom);
}
function zoomOut() {
  zoom = Math.max(zoom / 1.2, 0.2);
  requestAnimationFrame(applyZoom);
}
function applyZoom() {
  canvas.style.transform = `scale(${zoom})`;
  canvas.style.transformOrigin = 'top left';
}
// Download/Export Logic
function downloadImage() {
  const dataURL = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = 'painting.png';
  link.click();
}
  if(selected==='rect') document.getElementById('rectBtn').classList.add('active');
// Rectangle Tool Logic
let rectStart = null;
canvas.addEventListener('mousedown', function(e) {
  if(tool==='rect') {
    rectStart = getXY(e);
  }
});
canvas.addEventListener('mouseup', function(e) {
  if(tool==='rect' && rectStart) {
    const rectEnd = getXY(e);
    ctx.strokeStyle = brushColor;
    ctx.lineWidth = brushSize;
    ctx.strokeRect(rectStart.x, rectStart.y, rectEnd.x-rectStart.x, rectEnd.y-rectStart.y);
    rectStart = null;
    saveState();
  }
});
  tool = selected;
  document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
  if(selected==='brush') document.getElementById('brushBtn').classList.add('active');
  if(selected==='fill') document.getElementById('fillBtn').classList.add('active');
  if(selected==='eraser') document.getElementById('eraserBtn').classList.add('active');
  if(selected==='picker') document.getElementById('pickerBtn').classList.add('active');
}
document.getElementById('brushSize').addEventListener('input', function() { brushSize = this.value; });
document.getElementById('brushColorInput').addEventListener('input', function() {
  brushColor = this.value;
});
function getXY(e) {
  const rect = canvas.getBoundingClientRect();
  let x, y;
  if (e.touches) {
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  }
  return { x, y };
}
function saveState() {
  history.push(canvas.toDataURL());
  if(history.length > 50) history.shift();
  redoStack = [];
  autosavePainting();
}
function undo() {
  if(history.length < 2) return;
  redoStack.push(history.pop());
  let img = new Image();
  img.src = history[history.length-1];
  img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); autosavePainting(); };
}
function redo() {
  if(redoStack.length === 0) return;
  let img = new Image();
  img.src = redoStack.pop();
  img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); history.push(img.src); autosavePainting(); };
}
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  autosavePainting();
}
canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mouseup', endDraw);
canvas.addEventListener('mouseout', endDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('touchstart', function(e) { drawing = true; startDraw(e); });
canvas.addEventListener('touchend', endDraw);
canvas.addEventListener('touchcancel', endDraw);
canvas.addEventListener('touchmove', draw);
function startDraw(e) {
  if(tool==='picker') {
    pickColor(e);
    drawing = false;
    return;
  }
  drawing = true;
  const {x, y} = getXY(e);
  if(tool==='brush' || tool==='eraser') {
    draw(e);
  }
  if(tool==='fill') floodFill(x, y, brushColor);
  saveState();
}
function endDraw(e) {
  if(!drawing) return;
  drawing = false;
  ctx.beginPath();
}
function draw(e) {
  if (!drawing) return;
  const {x, y} = getXY(e);
  if(tool==='brush') {
    ctx.lineWidth = brushSize;
    ctx.lineCap = 'round';
    ctx.strokeStyle = brushColor;
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x, y);
    ctx.stroke();
  }
  if(tool==='eraser') {
    ctx.lineWidth = brushSize;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#fff';
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x, y);
    ctx.stroke();
  }
}
function floodFill(x, y, fillColor) {
  ctx.fillStyle = fillColor;
  ctx.beginPath(); ctx.arc(x, y, 20, 0, 2 * Math.PI); ctx.fill();
}
function savePainting() {
  const filename = prompt('Enter a name for your painting:', 'my_painting.png');
  if (!filename) return;
  // Save current canvas state
  const original = ctx.getImageData(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.globalCompositeOperation = 'destination-over';
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();
  const dataURL = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = filename.endsWith('.png') ? filename : filename + '.png';
  link.click();
  ctx.putImageData(original, 0, 0);
  document.getElementById('saveMsg').textContent = 'Painting saved as ' + link.download + '! Check your downloads.';
  setTimeout(()=>{ document.getElementById('saveMsg').textContent = ''; }, 3000);
}
// --- Mode Selection Logic ---
const levels = [
  {text:'Apple', icon:'🍎', outline:'media/movies/apple-439397_640_outline.png', ref:'media/movies/apple-439397_640.webp'},
  {text:'House', icon:'🏠', outline:'media/movies/house-outline.png', ref:'media/movies/635217f73e372771013edb4c-the-avengers-poster-marvel-movie-canvas1.jpg'},
  {text:'Tree', icon:'🌳', outline:'media/movies/tree-outline.png', ref:'media/movies/feUv2SYumXlT8E2RhzlYbZxfEGLG5AVrCPxP1gmAaCusxyPnA1.jpg'},
  {text:'Car', icon:'🚗', outline:'media/movies/car-outline.png', ref:'media/movies/f5VK0h2bprRhR6iRrixcuEfRxSUF4l14F66vQYrsJGmKZ5nTA1.jpg'}
];
let currentLevel = 0;
function startLevelMode() {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('levelChooser').style.display = 'block';
  renderLevelButtons();
}
function backToModeSelect() {
  document.getElementById('levelChooser').style.display = 'none';
  document.getElementById('modeSelect').style.display = 'flex';
}
function renderLevelButtons() {
  const levelBtns = document.getElementById('levelBtns');
  levelBtns.innerHTML = '';
  levels.forEach((level, idx) => {
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerHTML = `
      <span>${level.icon}</span>
      <span>${level.text}</span>
      <span style='font-size:1.1rem;color:#ff4066;'>${['Apple','House','Tree','Car'][idx] === 'Apple' ? '🍏' : ['House','Tree','Car'][idx] === 'House' ? '🏡' : ['House','Tree','Car'][idx] === 'Tree' ? '🌲' : '🚙'}</span>
    `;
    btn.onclick = function() { startLevel(idx); };
    levelBtns.appendChild(btn);
  });
}
function startLevel(idx) {
  currentLevel = idx;
  document.getElementById('levelChooser').style.display = 'none';
  loadLevelOutline();
}
function loadLevelOutline() {
  clearCanvas();
  const img = new Image();
  img.src = '/' + levels[currentLevel].outline;
  img.onload = function() {
    // Always fit image horizontally, preserving natural orientation
    const canvasAspect = canvas.width / canvas.height;
    const imgAspect = img.width / img.height;
    let drawWidth, drawHeight, offsetX, offsetY;
    // Add vertical and horizontal padding (10% of each dimension)
    const vPad = canvas.height * 0.1;
    const hPad = canvas.width * 0.1;
    let availableHeight = canvas.height - 2 * vPad;
    let availableWidth = canvas.width - 2 * hPad;
    if (imgAspect > canvasAspect) {
      drawWidth = availableWidth;
      drawHeight = drawWidth / imgAspect;
      if (drawHeight > availableHeight) {
        drawHeight = availableHeight;
        drawWidth = drawHeight * imgAspect;
      }
    } else {
      drawHeight = availableHeight;
      drawWidth = drawHeight * imgAspect;
      if (drawWidth > availableWidth) {
        drawWidth = availableWidth;
        drawHeight = drawWidth / imgAspect;
      }
    }
    offsetX = (canvas.width - drawWidth) / 2;
    offsetY = (canvas.height - drawHeight) / 2;
    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
  };
  // Show apple reference image only for Apple level
  const imgDiv = document.getElementById('levelSampleImg');
  if (levels[currentLevel].text === 'Apple') {
    imgDiv.innerHTML = `<img src='/media/movies/apple-439397_640.webp' alt='Sample' style='max-width:120px;max-height:120px;border-radius:12px;border:2px solid #00b8ff;box-shadow:0 2px 8px #00b8ff44;'>`;
    imgDiv.style.display = 'block';
  } else {
    imgDiv.innerHTML = '';
    imgDiv.style.display = 'none';
  }
  // Optionally show reference image
  // You can add a reference image display here if needed
}
function startPaintMode() {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('importModal').style.display = 'none'; // Hide import modal by default
  document.getElementById('levelChooser').style.display = 'none';
}

// Show Import Modal from toolbar (global function)
function showImportModal() {
  document.getElementById('importModal').style.display = 'flex';
}
function importDrawing() {
  const fileInput = document.getElementById('importFile');
  if (fileInput.files.length === 0) return;
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    clearCanvas();
    const img = new Image();
    img.src = e.target.result;
    img.onload = function() {
      // Fit imported image to canvas with padding, preserving aspect ratio
      const canvasAspect = canvas.width / canvas.height;
      const imgAspect = img.width / img.height;
      let drawWidth, drawHeight, offsetX, offsetY;
      const vPad = canvas.height * 0.1;
      const hPad = canvas.width * 0.1;
      let availableHeight = canvas.height - 2 * vPad;
      let availableWidth = canvas.width - 2 * hPad;
      if (imgAspect > canvasAspect) {
        drawWidth = availableWidth;
        drawHeight = drawWidth / imgAspect;
        if (drawHeight > availableHeight) {
          drawHeight = availableHeight;
          drawWidth = drawHeight * imgAspect;
        }
      } else {
        drawHeight = availableHeight;
        drawWidth = drawHeight * imgAspect;
        if (drawWidth > availableWidth) {
          drawWidth = availableWidth;
          drawHeight = drawWidth / imgAspect;
        }
      }
      offsetX = (canvas.width - drawWidth) / 2;
      offsetY = (canvas.height - drawHeight) / 2;
  ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
  document.getElementById('importModal').style.display = 'none';
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('levelChooser').style.display = 'none';
  autosavePainting();
    };
  };
  reader.readAsDataURL(file);
}
</script>
{% endblock %}
