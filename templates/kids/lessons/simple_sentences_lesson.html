{% extends 'base.html' %}
{% block content %}
<style>
  body {
    background: linear-gradient(120deg, #f8ffae 0%, #e0f7fa 100%, #ffd6e0 120%);
  }
  .lesson-container {
    max-width: 700px;
    margin: 2rem auto;
    background: linear-gradient(135deg, #fffbe6 60%, #e0ffe5 100%, #ffd6e0 120%);
    border-radius: 2rem;
    box-shadow: 0 8px 32px #ffd60a33, 0 2px 8px #2d6a4f22;
    padding: 2.5rem 2rem;
    position: relative;
  }
  .lesson-title {
    color: #ff4066;
    font-size: 2.5rem;
    margin-bottom: 1rem;
    font-family: 'Luckiest Guy', 'Comic Sans MS', cursive;
    text-shadow: 0 2px 8px #ffd60a44;
    text-align: center;
  }
  .lesson-desc {
    color: #2d6a4f;
    font-size: 1.2rem;
    margin-bottom: 1.5rem;
    text-align: center;
    font-family: 'Baloo 2', cursive;
  }
  .practice-section, .try-yourself-section, .comprehension-section {
    background: linear-gradient(135deg, #e0ffe5 0%, #e0f7fa 100%, #fff9c4 120%);
    border-radius: 1.5rem;
    box-shadow: 0 4px 18px #ffd60a22;
    padding: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
  }
  .practice-section h3, .try-yourself-section h3, .comprehension-section h3 {
    color: #ff4066;
    font-family: 'Luckiest Guy', 'Comic Sans MS', cursive;
    font-size: 1.5rem;
    margin-bottom: 1rem;
    text-shadow: 0 2px 8px #ffd60a44;
  }
  .sentence-card {
    background: #e0f7fa;
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px #ffd60a22;
    flex-wrap: wrap;
    position: relative;
    transition: box-shadow 0.3s, transform 0.3s;
  }
  .sentence-card:hover {
    box-shadow: 0 6px 24px #ffd60a66;
    transform: scale(1.03);
  }
  .mascot-emoji {
    animation: mascot-bounce 1.2s infinite alternate;
    margin-left: 0.5rem;
    cursor: pointer;
    font-size: 2rem;
  }
  @keyframes mascot-bounce {
    0% { transform: translateY(0); }
    100% { transform: translateY(-8px); }
  }
  .progress-bar-bg {
    width: 100%;
    height: 12px;
    background: #f1faee;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffd60a 60%, #ff4066 100%);
    width: 0%;
    border-radius: 8px;
    transition: width 0.5s;
  }
  .game-mascot {
    font-size: 2.5rem;
    text-align: center;
    margin-top: 0.7rem;
    min-height: 2.2rem;
    transition: color 0.3s;
    animation: mascot-bounce 1.2s infinite alternate;
  }
  .sentence-text { font-size: 1.3rem; color: #2d6a4f; flex: 1; }
  .speak-btn { background: #ffd60a; border: none; border-radius: 50%; font-size: 1.2rem; padding: 0.5rem 0.7rem; cursor: pointer; transition: background 0.2s; }
  .speak-btn:hover { background: #ff4066; color: #fff; }
  .sentence-img { max-width: 60px; border-radius: 0.7rem; margin-left: 0.5rem; }
  .mascot-feedback { margin-top: 1.5rem; font-size: 1.2rem; color: #ff4066; text-align: center; min-height: 2.5rem; }
  .word { cursor:pointer; padding:0 2px; border-radius:4px; transition:background 0.2s; }
  .word.active { background:#ffd60a; color:#ff4066; font-weight:bold; }
  #buildArea {
    min-height:2.2rem;
    background:#fffbe6;
    border-radius:0.7rem;
    padding:0.5rem;
    margin-bottom:0.7rem;
    display:flex;
    gap:0.5rem;
    flex-wrap:wrap;
  }
  #wordBank { margin-bottom:0.7rem; }
  .word-bank-item {
    background:#ffd60a;
    border-radius:0.5rem;
    padding:0.3rem 0.7rem;
    margin:0.2rem;
    cursor:pointer;
    display:inline-block;
    font-size:1.1rem;
    word-break:break-word;
    box-shadow: 0 2px 8px #ffd60a22;
    transition: background 0.2s, color 0.2s;
  }
  .word-bank-item:hover { background:#ff4066; color:#fff; }
  .check-btn {
    background:#2d6a4f;
    color:#fff;
    border:none;
    border-radius:0.7rem;
    padding:0.7rem 1.5rem;
    font-size:1.1rem;
    margin-top:0.5rem;
    cursor:pointer;
    display:block;
    margin-left:auto;
    margin-right:auto;
    box-shadow:0 2px 8px #2d6a4f22;
    font-family: 'Baloo 2', cursive;
    transition: background 0.2s, color 0.2s;
  }
  .check-btn:hover { background:#ffd60a; color:#2d6a4f; }
  .progress-tracker {
    background:#f1faee;
    border-radius:1rem;
    padding:0.7rem;
    margin-bottom:1.2rem;
    display:flex;
    gap:1.5rem;
    justify-content:center;
    font-size:1.1rem;
    flex-wrap:wrap;
    font-family: 'Baloo 2', cursive;
  }
  .comprehension-section {
    background:#e0f7fa;
    border-radius:1rem;
    padding:1rem;
    margin-bottom:1.5rem;
    box-shadow: 0 2px 8px #ffd60a22;
  }
  #compQuestion { font-size:1.1rem; margin-bottom:0.5rem; }
  .emoji {
    font-size: 2rem;
    margin-right: 0.3rem;
    vertical-align: middle;
  }
  /* Fun background shapes */
  .fun-bg-shapes {
    position: fixed;
    left: 0; top: 0; width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: 0;
  }
  .fun-bg-shapes span {
    position: absolute;
    font-size: 3rem;
    opacity: 0.10;
    animation: floatShape 8s infinite linear alternate;
  }
  @keyframes floatShape {
    0% { transform: translateY(0) scale(1); }
    100% { transform: translateY(-40px) scale(1.2); }
  }
</style>
<div class="fun-bg-shapes">
  <span style="left:10vw;top:12vh;">&#9679;</span>
  <span style="left:30vw;top:22vh;">&#9632;</span>
  <span style="left:60vw;top:18vh;">&#9651;</span>
  <span style="left:80vw;top:28vh;">&#9645;</span>
  <span style="left:50vw;top:60vh;">&#11036;</span>
</div>

<div class="row mb-5">
  <div class="col-12">
    <div class="card shadow-lg border-0 animate__animated animate__fadeInUp" style="background: linear-gradient(135deg, #e0f7fa 60%, #ffe5e5 100%); border-radius:1.5rem;">
      <div class="card-body text-center">
        <h2 class="fw-bold mb-3" style="color:#2d6a4f; font-family:'Comic Sans MS', 'Comic Sans', cursive;">
          <span style="font-size:2rem;">üé¨</span> Watch & Learn!
        </h2>
        {% if video_embed_url %}
        <div class="ratio ratio-16x9 mb-3">
          <iframe width="100%" height="360" src="{{ video_embed_url }}" title="Lesson Video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius:1rem; box-shadow:0 4px 24px rgba(0,0,0,0.10);"></iframe>
        </div>
        {% elif lesson.video_url %}
        <div class="ratio ratio-16x9 mb-3">
          <video width="100%" controls poster="/static/video_poster.png" style="border-radius:1rem; box-shadow:0 4px 24px rgba(0,0,0,0.10);">
            <source src="{{ lesson.video_url }}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
        {% else %}
        <div class="video-caption">No video available for this lesson.</div>
        {% endif %}
        <p class="mt-2" style="font-size:1.15rem; color:#333;">Learn with this video and try the activities below!</p>
      </div>
    </div>
  </div>
</div>

<div class="lesson-container">
  <h2 class="lesson-title">{{ lesson.title }}</h2>
  <div class="lesson-desc">{{ lesson.content }}</div>

  <div id="sentencePractice" class="practice-section">
    <h3>Read These Sentences</h3>
    <div id="sentencesList">
      {% for sentence in sentences %}
      <div class="sentence-card animated-card">
        <span class="sentence-text" id="sentence-{{ forloop.counter }}">
          {% for word in sentence.words %}
            <span class="word" onclick="speakWord('{{ word|escapejs }}', this)">{{ word }}</span>
          {% endfor %}
        </span>
        <button class="speak-btn" onclick="speakSentence('{{ sentence.text|escapejs }}', '{{ forloop.counter }}')">üîä</button>
        {% if sentence.image %}
        <img src="{{ sentence.image.url }}" class="sentence-img" />
        {% endif %}
        <span class="emoji mascot-emoji" title="Great job!">üéâ</span>
      </div>
      {% endfor %}
    </div>
  </div>

  <div id="tryYourselfSection" class="try-yourself-section">
    <h3>Try Yourself: Build the Sentence <span class="game-emoji">üß©</span></h3>
    <div id="realSentenceDisplay" style="font-size:1.1rem; color:#2d6a4f; margin-bottom:0.5rem;"></div>
    <div class="progress-bar-bg"><div id="progressBar" class="progress-bar"></div></div>
    <div id="buildArea"></div>
    <div id="wordBank"></div>
    <button onclick="checkBuild()" class="check-btn">Check</button>
    <div id="buildFeedback"></div>
    <div id="userAnswerDisplay" style="font-size:1rem; color:#ff4066; margin-top:0.5rem;"></div>
    <div id="gameMascot" class="game-mascot">üòÉ</div>
  </div>

<script>
function stripSymbols(str) {
  return str.replace(/[^\w ]/g, '').replace(/_/g, '');
}
  function stripSymbols(str) {
    return str.replace(/[^\w ]/g, '').replace(/_/g, '').toLowerCase();
  }
// ...existing JS code...
</script>

  <div id="progressTracker" class="progress-tracker">
    <span id="starCount">Stars: 0</span>
    <span id="streakCount">Streak: 0</span>
    <span id="badge">Badge: Beginner</span>
  </div>

  <div id="fillBlankSection" class="comprehension-section">
    <a href="{% url 'fill_blank_test' lesson.id %}" class="check-btn" style="margin-bottom:1rem;display:inline-block;">Start Fill in the Blank Test üìù</a>
    <h3>Fill in the Blank Test <span class="test-emoji">üìù</span></h3>
    <div class="test-instructions">Type the missing word for each sentence. Try to finish as many as you can!</div>
    <div class="test-progress">
      <span id="blankProgress">Question 1 of 1</span>
      <span id="blankTimer">Time: 0s</span>
    </div>
    <div id="blankQuestion" class="blank-question"></div>
    <input type="text" id="blankAnswer" placeholder="Type the missing word..." autocomplete="off" />
    <button onclick="checkBlank()" id="blankSubmitBtn" class="check-btn">Submit</button>
    <div id="blankFeedback" class="blank-feedback"></div>
    <div id="blankSummary" class="blank-summary"></div>
  </div>

  <div id="mascotFeedback" class="mascot-feedback"></div>
</div>

<style>
  .lesson-container {
    max-width: 600px;
    margin: 2rem auto;
    background: #fffbe6;
    border-radius: 1.5rem;
    box-shadow: 0 4px 24px #ffd60a33;
    padding: 2rem;
  }
  .lesson-title { color: #ff4066; font-size: 2rem; margin-bottom: 1rem; }
  .lesson-desc { color: #2d6a4f; font-size: 1.1rem; margin-bottom: 1.5rem; }
  .practice-section { margin-bottom: 2rem; }
  .sentence-card {
    background: #e0f7fa;
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px #ffd60a22;
    flex-wrap: wrap;
    position: relative;
    transition: box-shadow 0.3s, transform 0.3s;
  }
  .animated-card:hover {
    box-shadow: 0 6px 24px #ffd60a66;
    transform: scale(1.03);
  }
  .mascot-emoji {
    animation: mascot-bounce 1.2s infinite alternate;
    margin-left: 0.5rem;
    cursor: pointer;
  }
  @keyframes mascot-bounce {
    0% { transform: translateY(0); }
    100% { transform: translateY(-8px); }
  }
  .progress-bar-bg {
    width: 100%;
    height: 12px;
    background: #f1faee;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffd60a 60%, #ff4066 100%);
    width: 0%;
    border-radius: 8px;
    transition: width 0.5s;
  }
  .game-mascot {
    font-size: 2rem;
    text-align: center;
    margin-top: 0.7rem;
    min-height: 2.2rem;
    transition: color 0.3s;
  }
  .sentence-text { font-size: 1.3rem; color: #2d6a4f; flex: 1; }
  .speak-btn { background: #ffd60a; border: none; border-radius: 50%; font-size: 1.2rem; padding: 0.5rem 0.7rem; cursor: pointer; transition: background 0.2s; }
  .speak-btn:hover { background: #ff4066; color: #fff; }
  .sentence-img { max-width: 60px; border-radius: 0.7rem; margin-left: 0.5rem; }
  .review-section { background: #f1faee; border-radius: 1rem; padding: 1rem; }
  .mascot-feedback { margin-top: 1.5rem; font-size: 1.2rem; color: #ff4066; text-align: center; min-height: 2.5rem; }
  .word { cursor:pointer; padding:0 2px; border-radius:4px; transition:background 0.2s; }
  .word.active { background:#ffd60a; color:#ff4066; font-weight:bold; }
  .try-yourself-section { background:#e0f7fa; border-radius:1rem; padding:1rem; margin-bottom:1.5rem; }
  #buildArea {
    min-height:2.2rem;
    background:#fffbe6;
    border-radius:0.7rem;
    padding:0.5rem;
    margin-bottom:0.7rem;
    display:flex;
    gap:0.5rem;
    flex-wrap:wrap;
  }
  #wordBank { margin-bottom:0.7rem; }
  .word-bank-item {
    background:#ffd60a;
    border-radius:0.5rem;
    padding:0.3rem 0.7rem;
    margin:0.2rem;
    cursor:pointer;
    display:inline-block;
    font-size:1.1rem;
    word-break:break-word;
  }
  .word-bank-item:hover { background:#ff4066; color:#fff; }
  .check-btn { background:#2d6a4f; color:#fff; border:none; border-radius:0.7rem; padding:0.5rem 1.2rem; font-size:1rem; margin-top:0.5rem; cursor:pointer; }
  .progress-tracker {
    background:#f1faee;
    border-radius:1rem;
    padding:0.7rem;
    margin-bottom:1.2rem;
    display:flex;
    gap:1.5rem;
    justify-content:center;
    font-size:1.1rem;
    flex-wrap:wrap;
  }
  .comprehension-section { background:#e0f7fa; border-radius:1rem; padding:1rem; margin-bottom:1.5rem; }
  #compQuestion { font-size:1.1rem; margin-bottom:0.5rem; }

  /* Responsive styles */
  @media (max-width: 700px) {
    .lesson-container {
      max-width: 98vw;
      padding: 1rem;
      border-radius: 1rem;
    }
    .lesson-title { font-size: 1.4rem; }
    .lesson-desc { font-size: 1rem; }
    .sentence-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 0.7rem; }
    .sentence-text { font-size: 1.1rem; }
    .sentence-img { max-width: 40px; }
    .mascot-feedback { font-size: 1rem; }
    #buildArea, #wordBank { font-size: 1rem; }
    .word-bank-item { font-size: 1rem; padding: 0.25rem 0.5rem; }
    .check-btn { font-size: 0.95rem; padding: 0.4rem 1rem; }
    .progress-tracker { font-size: 1rem; gap: 0.7rem; padding: 0.5rem; }
    .review-section, .comprehension-section, .try-yourself-section {
      padding: 0.7rem;
      border-radius: 0.7rem;
    }
  }
  @media (max-width: 480px) {
    .lesson-title { font-size: 1.1rem; }
    .sentence-text { font-size: 0.95rem; }
    .word-bank-item { font-size: 0.9rem; padding: 0.18rem 0.35rem; }
    .check-btn { font-size: 0.9rem; padding: 0.3rem 0.7rem; }
    .progress-tracker { font-size: 0.9rem; gap: 0.4rem; padding: 0.3rem; }
    .mascot-feedback { font-size: 0.9rem; }
    .sentence-img { max-width: 28px; }
  }
</style>

<script>
let currentSentenceIdx = 1;
let stars = 0;
let streak = 0;
let badge = 'Beginner';
const badgeLevels = ['Beginner','Reader','Star','Champion'];

function speakSentence(text, idx) {
  currentSentenceIdx = idx;
  const synth = window.speechSynthesis;
  const words = text.split(' ');
  let i = 0;
  function highlightWord(j) {
    document.querySelectorAll(`#sentence-${idx} .word`).forEach((el, k) => {
      el.classList.toggle('active', k === j);
    });
  }
  function clearHighlight() {
    document.querySelectorAll(`#sentence-${idx} .word`).forEach(el => el.classList.remove('active'));
  }
  function speakNext() {
    if (i < words.length) {
      highlightWord(i);
      let utter = new SpeechSynthesisUtterance(words[i]);
      utter.rate = 0.85;
      utter.pitch = 1.1;
      utter.onend = function() {
        i++;
        speakNext();
      };
      window.speechSynthesis.speak(utter);
    } else {
      clearHighlight();
      showMascot('Great job!');
      addToReview(text);
      confettiEffect();
      updateProgress();
      showComprehension(text);
    }
  }
  showMascot('Listen and repeat!');
  speakNext();
}

function speakWord(word, el) {
  const synth = window.speechSynthesis;
  let utter = new SpeechSynthesisUtterance(word);
  utter.rate = 0.85;
  utter.pitch = 1.1;
  el.classList.add('active');
  utter.onend = function() {
    el.classList.remove('active');
    showMascot('You heard: ' + word);
  };
  synth.speak(utter);
}

function showMascot(msg) {
  document.getElementById('mascotFeedback').textContent = msg;
}

function addToReview(sentence) {
  const reviewList = document.getElementById('reviewList');
  const li = document.createElement('li');
  li.textContent = sentence;
  reviewList.appendChild(li);
}

function confettiEffect() {
  const mascot = document.getElementById('mascotFeedback');
  mascot.style.background = '#ffd60a';
  setTimeout(() => mascot.style.background = '', 500);
}

function updateProgress() {
  stars++;
  streak++;
  if (stars > 10) badge = badgeLevels[1];
  if (stars > 20) badge = badgeLevels[2];
  if (stars > 30) badge = badgeLevels[3];
  document.getElementById('starCount').textContent = 'Stars: ' + stars;
  document.getElementById('streakCount').textContent = 'Streak: ' + streak;
  document.getElementById('badge').textContent = 'Badge: ' + badge;
}

// Try Yourself: Improved Drag to Build Sentence
let buildWords = [];
let correctSentence = '';
function stripSymbols(str) {
  return str.replace(/[^\w ]/g, '').replace(/_/g, '');
}
function isMobile() {
  return window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
}
let realSentence = '';
function showBuildSentence(sentence) {
  realSentence = sentence;
  document.getElementById('realSentenceDisplay').textContent = 'Original: ' + realSentence;
  correctSentence = stripSymbols(sentence);
  buildWords = correctSentence.split(' ').filter(w => w.match(/^[a-zA-Z]+$/));
  buildWords = shuffle(buildWords);
  const wordBank = document.getElementById('wordBank');
  wordBank.innerHTML = '';
  const buildArea = document.getElementById('buildArea');
  buildArea.innerHTML = '';
  document.getElementById('userAnswerDisplay').textContent = '';
  document.getElementById('buildFeedback').textContent = '';
  document.getElementById('buildArea').style.background = '';
  document.getElementById('gameMascot').textContent = 'üòÉ';
  document.getElementById('gameMascot').style.color = '';

  function addWordToBuild(word) {
    if (Array.from(buildArea.children).some(x => x.textContent === word)) return;
    const span = document.createElement('span');
    span.textContent = word;
    span.className = 'word-bank-item';
    if (!isMobile()) {
      span.draggable = true;
      span.ondragstart = function(ev) {
        ev.dataTransfer.setData('text/plain', word);
        ev.dataTransfer.setData('from', 'build');
      };
    }
    // Touch: tap to move back to word bank
    if (isMobile()) {
      span.onclick = function() {
        addWordToBank(word);
        buildArea.removeChild(span);
      };
    }
    buildArea.appendChild(span);
  }
  function addWordToBank(word) {
    if (Array.from(wordBank.children).some(x => x.textContent === word)) return;
    const span = document.createElement('span');
    span.textContent = word;
    span.className = 'word-bank-item';
    if (!isMobile()) {
      span.draggable = true;
      span.ondragstart = function(ev) {
        ev.dataTransfer.setData('text/plain', word);
        ev.dataTransfer.setData('from', 'bank');
      };
    }
    // Touch: tap to move to build area
    if (isMobile()) {
      span.onclick = function() {
        addWordToBuild(word);
        wordBank.removeChild(span);
      };
    }
    wordBank.appendChild(span);
  }
  buildWords.forEach(word => addWordToBank(word));

  if (!isMobile()) {
    buildArea.ondragover = function(e) { e.preventDefault(); };
    buildArea.ondrop = function(e) {
      e.preventDefault();
      const word = e.dataTransfer.getData('text/plain');
      const from = e.dataTransfer.getData('from');
      if (Array.from(buildArea.children).some(x => x.textContent === word)) return;
      addWordToBuild(word);
      if (from === 'bank') {
        Array.from(wordBank.children).forEach(child => {
          if (child.textContent === word) wordBank.removeChild(child);
        });
      }
    };
    wordBank.ondragover = function(e) { e.preventDefault(); };
    wordBank.ondrop = function(e) {
      e.preventDefault();
      const word = e.dataTransfer.getData('text/plain');
      const from = e.dataTransfer.getData('from');
      if (Array.from(wordBank.children).some(x => x.textContent === word)) return;
      addWordToBank(word);
      if (from === 'build') {
        Array.from(buildArea.children).forEach(child => {
          if (child.textContent === word) buildArea.removeChild(child);
        });
      }
    };
  }
  // Add clear button
  let clearBtn = document.getElementById('clearBuildBtn');
  if (!clearBtn) {
    clearBtn = document.createElement('button');
    clearBtn.id = 'clearBuildBtn';
    clearBtn.textContent = 'Clear';
    clearBtn.onclick = function() {
      // Move all words back to word bank
      Array.from(buildArea.children).forEach(child => {
        const word = child.textContent;
        if (!Array.from(wordBank.children).some(x => x.textContent === word)) {
          addWordToBank(word);
        }
      });
      buildArea.innerHTML = '';
      document.getElementById('buildFeedback').textContent = '';
    };
    buildArea.parentNode.insertBefore(clearBtn, buildArea.nextSibling);
  }
  clearBtn.style.display = 'inline-block';
}
function checkBuild() {
  const buildArea = document.getElementById('buildArea');
  const built = Array.from(buildArea.children).map(x => x.textContent).join(' ');
  document.getElementById('userAnswerDisplay').textContent = 'Your answer: ' + built;
  // Hide correct answer display (if any)
  // If you want to show the correct answer only after a wrong attempt, you can add logic here
  const feedback = document.getElementById('buildFeedback');
  const mascot = document.getElementById('gameMascot');
  // Compare both answers: lowercase, stripped of symbols and extra spaces
  const userAnswer = stripSymbols(built).replace(/\s+/g, ' ').trim().toLowerCase();
  const correct = correctSentence.replace(/\s+/g, ' ').trim().toLowerCase();
  if (userAnswer === correct) {
    feedback.textContent = 'üéâ Correct!';
    feedback.style.color = 'green';
    buildArea.style.background = '#d4ffd4';
    mascot.textContent = 'ü•≥';
    mascot.style.color = '#ff4066';
    confettiEffect();
    updateProgress();
    updateProgressBar();
    showNextButton();
  } else {
    feedback.textContent = '‚ùå Try again.';
    feedback.style.color = 'red';
    buildArea.style.background = '#ffd4d4';
    mascot.textContent = 'üòï';
    mascot.style.color = '#2d6a4f';
    streak = 0;
    document.getElementById('streakCount').textContent = 'Streak: ' + streak;
    updateProgressBar();
    showNextButton();
  }
// Show Next Question button
function showNextButton() {
  let nextBtn = document.getElementById('nextBuildBtn');
  if (!nextBtn) {
    nextBtn = document.createElement('button');
    nextBtn.id = 'nextBuildBtn';
    nextBtn.textContent = 'Next Question';
    nextBtn.className = 'check-btn';
    nextBtn.onclick = function() {
      nextBtn.remove();
      showNextBuildSentence();
    };
    document.getElementById('tryYourselfSection').appendChild(nextBtn);
  }
  nextBtn.style.display = 'inline-block';
}
// Show next sentence in Try Yourself
let buildSentenceIdx = 0;
let usedSentenceIdxs = [];
function showNextBuildSentence() {
  const sentenceEls = document.querySelectorAll('.sentence-text');
  if (usedSentenceIdxs.length >= sentenceEls.length) {
    document.getElementById('realSentenceDisplay').textContent = 'All done! üéâ';
    document.getElementById('wordBank').innerHTML = '';
    document.getElementById('buildArea').innerHTML = '';
    document.getElementById('buildFeedback').textContent = 'Great job! You finished all sentences.';
    document.getElementById('gameMascot').textContent = 'üèÜ';
    return;
  }
  // Pick a random unused sentence
  let nextIdx;
  do {
    nextIdx = Math.floor(Math.random() * sentenceEls.length);
  } while (usedSentenceIdxs.includes(nextIdx) && usedSentenceIdxs.length < sentenceEls.length);
  usedSentenceIdxs.push(nextIdx);
  buildSentenceIdx = nextIdx;
  showBuildSentence(sentenceEls[buildSentenceIdx].textContent);
}
// Initialize first build sentence
window.onload = function() {
  const sentenceEls = document.querySelectorAll('.sentence-text');
  buildSentenceIdx = 0;
  usedSentenceIdxs = [];
  if (sentenceEls.length > 0) {
    // Pick a random first sentence
    let firstIdx = Math.floor(Math.random() * sentenceEls.length);
    usedSentenceIdxs.push(firstIdx);
    buildSentenceIdx = firstIdx;
    showBuildSentence(sentenceEls[buildSentenceIdx].textContent);
  }
};
}
function updateProgressBar() {
  const bar = document.getElementById('progressBar');
  let percent = Math.min(100, stars * 3);
  bar.style.width = percent + '%';
}
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Fill in the Blank test logic
let blankQuestions = [];
let blankIdx = 0;
let blankCorrect = 0;
let blankStartTime = 0;
let blankTimerInterval = null;
function generateBlankQuestions() {
  // Use sentences from the lesson for blanks, shuffle for randomness
  const sentenceEls = Array.from(document.querySelectorAll('.sentence-text'));
  blankQuestions = [];
  sentenceEls.forEach(el => {
    const words = el.textContent.split(' ');
    if (words.length > 2) {
      // Pick a random word to blank
      const idx = Math.floor(Math.random() * words.length);
      const answer = words[idx];
      const blanked = words.map((w, i) => i === idx ? '_____' : w).join(' ');
      blankQuestions.push({q: blanked, a: answer, full: el.textContent});
    }
  });
  // Shuffle questions
  for (let i = blankQuestions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [blankQuestions[i], blankQuestions[j]] = [blankQuestions[j], blankQuestions[i]];
  }
  blankIdx = 0;
  blankCorrect = 0;
}
function showBlankQuestion() {
  if (blankIdx >= blankQuestions.length) {
    endBlankTest();
    return;
  }
  document.getElementById('blankQuestion').textContent = blankQuestions[blankIdx].q;
  document.getElementById('blankAnswer').value = '';
  document.getElementById('blankAnswer').style.display = '';
  document.getElementById('blankSubmitBtn').style.display = '';
  document.getElementById('blankFeedback').textContent = '';
  document.getElementById('blankSummary').textContent = '';
  document.getElementById('blankProgress').textContent = `Question ${blankIdx+1} of ${blankQuestions.length}`;
}
function checkBlank() {
  const ans = document.getElementById('blankAnswer').value.trim().toLowerCase();
  const correct = blankQuestions[blankIdx].a.trim().toLowerCase();
  if (ans === correct) {
    document.getElementById('blankFeedback').textContent = '‚úÖ Correct!';
    confettiEffect();
    blankCorrect++;
    blankIdx++;
    setTimeout(showBlankQuestion, 800);
  } else {
    document.getElementById('blankFeedback').textContent = `‚ùå Try again. Hint: The full sentence is "${blankQuestions[blankIdx].full}"`;
    streak = 0;
    document.getElementById('streakCount').textContent = 'Streak: ' + streak;
  }
}
function startBlankTimer() {
  blankStartTime = Date.now();
  blankTimerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - blankStartTime)/1000);
    document.getElementById('blankTimer').textContent = `Time: ${elapsed}s`;
  }, 1000);
}
function endBlankTest() {
  if (blankTimerInterval) clearInterval(blankTimerInterval);
  document.getElementById('blankQuestion').textContent = 'Test Complete!';
  document.getElementById('blankAnswer').style.display = 'none';
  document.getElementById('blankSubmitBtn').style.display = 'none';
  const total = blankQuestions.length;
  const percent = Math.round((blankCorrect/total)*100);
  const elapsed = Math.floor((Date.now() - blankStartTime)/1000);
  document.getElementById('blankSummary').innerHTML = `<b>Your Score:</b> ${blankCorrect} / ${total} (${percent}%)<br><b>Time Taken:</b> ${elapsed} seconds`;
  document.getElementById('blankFeedback').textContent = 'Great job!';
}
// Initialize blanks on load
window.onload = function() {
  // ...existing code...
  generateBlankQuestions();
  showBlankQuestion();
  startBlankTimer();
};

// Initialize first build sentence
window.onload = function() {
  const firstSentence = document.querySelector('.sentence-text');
  if (firstSentence) showBuildSentence(firstSentence.textContent);
};
</script>

{% if next_lesson %}
  <div style="text-align:center; margin-top:2rem;">
    <a href="{% url 'lesson_detail' next_lesson.id %}" class="check-btn" style="font-size:1.2rem; padding:0.8rem 2rem; border-radius:1.2rem; background:linear-gradient(90deg,#ffd60a 0%,#ff4066 100%); color:#2d6a4f; font-family:'Baloo 2',cursive; font-weight:bold; box-shadow:0 2px 8px #ffd60a22;">Next Lesson: {{ next_lesson.title }} &rarr;</a>
  </div>
{% endif %}
{% endblock %}
