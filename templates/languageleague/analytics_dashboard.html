{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
.page-section {
  margin-top: 60px;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}
@media (max-width: 900px) {
  .page-section { max-width: 100%; }
}
@media (max-width: 768px) {
  .page-section { margin-top: 40px; }
}
</style>
<div class="page-section">
<div class="container py-4">
  <h2 class="mb-4">My Learning Analytics</h2>
  {% if user_progress %}
    <div class="row g-4">
      {% for progress in user_progress %}
        <div class="col-md-6">
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title mb-2">{{ progress.course.name }} <span class="badge bg-info">{{ progress.course.language.name }}</span></h5>
              <div class="mb-2">Lessons: <strong>{{ progress.completed_lessons.count }}</strong> / {{ progress.total_lessons }}</div>
              <div class="progress mb-2" style="height: 18px;">
                <div class="progress-bar bg-primary" role="progressbar" aria-valuenow="{{ progress.lesson_percent }}" aria-valuemin="0" aria-valuemax="100" data-percent="{{ progress.lesson_percent }}">{{ progress.lesson_percent }}%</div>
              </div>
              <div class="mb-2">Exercises: <strong>{{ progress.completed_exercises.count }}</strong> / {{ progress.total_exercises }}</div>
              <div class="progress mb-2" style="height: 18px;">
                <div class="progress-bar bg-success" role="progressbar" aria-valuenow="{{ progress.exercise_percent }}" aria-valuemin="0" aria-valuemax="100" data-percent="{{ progress.exercise_percent }}">{{ progress.exercise_percent }}%</div>
              </div>
              <div class="mb-2">
                {% if progress.certificate_awarded %}
                  <span class="badge bg-success"><i class="bi bi-award"></i> Certificate Awarded</span>
                  <a href="{% url 'certificate_download' progress.course.id %}" class="btn btn-outline-primary btn-sm ms-2">Download Certificate</a>
                {% else %}
                  <span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> In Progress</span>
                {% endif %}
              </div>
              {% if progress.next_lesson %}
                <div class="mb-1"><strong>Next Lesson:</strong> <span class="text-primary">{{ progress.next_lesson.title }}</span></div>
              {% endif %}
              {% if progress.next_exercise %}
                <div class="mb-1"><strong>Next Exercise:</strong> <span class="text-success">{{ progress.next_exercise.title }}</span></div>
              {% endif %}
              <div class="mt-2">
                <h6 class="mb-1">Notifications</h6>
                {% for note in progress.notifications %}
                  <div class="alert alert-info py-1 px-2 mb-1 small">{{ note }}</div>
                {% empty %}
                  <span class="text-muted small">No notifications.</span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-body">
        <h4 class="card-title mb-3">Overall Progress</h4>
        <canvas id="progressChart" height="120"></canvas>
      </div>
    </div>
    <script id="labels-data" type="application/json">{{ labels|safe }}</script>
    <script id="lesson-data" type="application/json">{{ lesson_percents|safe }}</script>
    <script id="exercise-data" type="application/json">{{ exercise_percents|safe }}</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Set progress bar widths using JS for linter compatibility
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.progress-bar[data-percent]').forEach(function(bar) {
          var percent = bar.getAttribute('data-percent');
          bar.style.width = percent + '%';
        });
      });
      function getJsonData(id) {
        return JSON.parse(document.getElementById(id).textContent);
      }
      var ctx = document.getElementById('progressChart').getContext('2d');
      var labels = getJsonData('labels-data');
      var lessonPercents = getJsonData('lesson-data');
      var exercisePercents = getJsonData('exercise-data');
      var progressData = {
        labels: labels,
        datasets: [
          {
            label: 'Lessons (%)',
            data: lessonPercents,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Exercises (%)',
            data: exercisePercents,
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }
        ]
      };
      var progressChart = new Chart(ctx, {
        type: 'bar',
        data: progressData,
        options: {
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    </script>
  {% else %}
    <div class="alert alert-info">No progress yet. Start learning a language to see your analytics!</div>
  {% endif %}
</div>
</div>
{% endblock %}
