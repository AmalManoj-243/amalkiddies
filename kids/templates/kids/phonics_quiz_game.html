{% extends 'base.html' %}
{% block content %}
{% if lesson_videos %}
  <div class="video-section">
    {% if lesson_videos|length > 0 %}
      <div class="video-card" style="max-width:650px; margin:2rem auto 2.5rem auto; text-align:center; border:2px solid #ffd60a; border-radius:1.5rem; box-shadow:0 4px 24px #ffd60a22; background:#fffbe6; padding:1.5rem;">
        <h2 style="font-family:'Baloo 2',cursive; color:#ff4066; font-size:2rem; margin-bottom:1.2rem;">What is Phonics?</h2>
    <p style="font-family:'Baloo 2',cursive; color:#2d6a4f; font-size:1.15rem; margin-bottom:1.2rem; max-width:540px; margin-left:auto; margin-right:auto;">Phonics is a method for teaching reading and writing by developing learners' phonemic awareness—the ability to hear, identify, and manipulate sounds—to help them understand the relationship between letters and sounds.</p>
        <div class="responsive-video" style="width:100%; max-width:600px; margin:auto; aspect-ratio:16/9; background:#000; border-radius:1rem; display:flex; align-items:center; justify-content:center;">
          {% if lesson_videos.0.video_url and 'youtube.com' in lesson_videos.0.video_url or 'youtu.be' in lesson_videos.0.video_url %}
            <iframe src="{{ lesson_videos.0.video_embed_url }}" title="What is Phonics?" frameborder="0" allowfullscreen style="width:100%; height:100%; min-height:220px; min-width:320px; border-radius:1.5rem; background:#000; display:block; margin:0 auto;"></iframe>
          {% else %}
            <video controls style="width:100%; height:auto; border-radius:1rem; background:#000; display:block; margin:0 auto;" preload="metadata">
              <source src="{{ lesson_videos.0.video_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            <div style="margin-top:0.7rem;">
              <a href="{{ lesson_videos.0.video_url }}" target="_blank" style="color:#ff9800; font-size:1rem; text-decoration:underline;">Open video in new tab</a>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
    {% if lesson_videos|length > 1 %}
      <div class="video-card" style="max-width:650px; margin:2rem auto 2.5rem auto; text-align:center; border:2px solid #43e97b; border-radius:1.5rem; box-shadow:0 4px 24px #38f9d799; background:#e0f7fa; padding:1.5rem;">
        <h2 style="font-family:'Baloo 2',cursive; color:#43e97b; font-size:2rem; margin-bottom:1.2rem;">Phonics Song</h2>
        <div class="responsive-video" style="width:100%; max-width:600px; margin:auto; aspect-ratio:16/9; background:#000; border-radius:1rem; display:flex; align-items:center; justify-content:center;">
          {% if lesson_videos.1.video_url and 'youtube.com' in lesson_videos.1.video_url or 'youtu.be' in lesson_videos.1.video_url %}
            <iframe src="{{ lesson_videos.1.video_embed_url }}" title="Phonics Song" frameborder="0" allowfullscreen style="width:100%; height:100%; min-height:220px; min-width:320px; border-radius:1.5rem; background:#000; display:block; margin:0 auto;"></iframe>
          {% else %}
            <video controls style="width:100%; height:auto; border-radius:1rem; background:#000; display:block; margin:0 auto;" preload="metadata">
              <source src="{{ lesson_videos.1.video_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            <div style="margin-top:0.7rem;">
              <a href="{{ lesson_videos.1.video_url }}" target="_blank" style="color:#43e97b; font-size:1rem; text-decoration:underline;">Open video in new tab</a>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}
<style>
  body {
    background: linear-gradient(120deg, #f8ffae 0%, #e0f7fa 100%, #ffd6e0 120%);
    overflow-x: hidden;
  }
  .quiz-container {
    max-width: 600px;
    margin: 2rem auto;
    background: #fffbe6;
    border-radius: 2rem;
    box-shadow: 0 8px 32px #ffd60a33;
    padding: 2.5rem 1.5rem 2rem 1.5rem;
    text-align: center;
    position: relative;
  }
  .mascot {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #ffd60a;
    box-shadow: 0 2px 12px #ffd60a55;
    margin-bottom: 1rem;
    animation: bounceIn 0.7s;
  }
  @keyframes bounceIn {
    0% { transform: scale(0.7); opacity: 0.2; }
    80% { transform: scale(1.15); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }
  .progress-bar {
    width: 100%;
    height: 18px;
    background: #e0f7fa;
    border-radius: 1rem;
    margin-bottom: 1.2rem;
    overflow: hidden;
    box-shadow: 0 2px 8px #ffd60a22;
  }
  .progress {
    height: 100%;
    background: linear-gradient(90deg,#ffd60a 0%,#ff9800 100%);
    border-radius: 1rem;
    transition: width 0.3s;
  }
  .score-panel {
    font-size: 1.1rem;
    color: #2d6a4f;
    font-family: 'Baloo 2', cursive;
    margin-bottom: 1rem;
    font-weight: bold;
  }
  .quiz-question {
    font-size: 1.3rem;
    color: #ff4066;
    font-family: 'Baloo 2', cursive;
    margin-bottom: 1.2rem;
    font-weight: bold;
    animation: bounceIn 0.7s;
  }
  .quiz-options {
    margin-bottom: 1.2rem;
  }
  .quiz-option {
    display: block;
    background: linear-gradient(90deg,#ffd60a 0%,#ff9800 100%);
    color: #2d6a4f;
    border-radius: 1rem;
    font-size: 1.1rem;
    font-family: 'Baloo 2', cursive;
    font-weight: bold;
    box-shadow: 0 2px 8px #ffd60a88;
    padding: 0.6rem 1.2rem;
    margin: 0.5rem auto;
    cursor: pointer;
    border: none;
    transition: background 0.2s, color 0.2s;
  }
  .quiz-option:hover {
    background: #ff4066;
    color: #fff;
    transform: scale(1.05);
  }
  .quiz-feedback {
    font-size: 1.1rem;
    color: #43e97b;
    margin-bottom: 1rem;
    font-family: 'Comic Sans MS', cursive;
    animation: bounceIn 0.7s;
  }
  .quiz-next-btn {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);
    color: #2d6a4f;
    border-radius: 1rem;
    font-size: 1.1rem;
    font-family: 'Baloo 2', cursive;
    font-weight: bold;
    box-shadow: 0 2px 8px #38f9d799;
    padding: 0.6rem 1.2rem;
    margin-top: 1rem;
    cursor: pointer;
    border: none;
    transition: background 0.2s, color 0.2s;
  }
  .quiz-next-btn:hover {
    background: #ffd60a;
    color: #fff;
    transform: scale(1.05);
  }
  .confetti {
    position: fixed;
    left: 50vw;
    top: 50vh;
    font-size: 2.5rem;
    pointer-events: none;
    animation: confettiAnim 1.2s ease-out;
    z-index: 9999;
  }
  @keyframes confettiAnim {
    0% { opacity: 1; transform: scale(1) translateY(0); }
    100% { opacity: 0; transform: scale(1.5) translateY(80px); }
  }
  .level-complete {
    font-size: 1.5rem;
    color: #ff4066;
    font-family: 'Baloo 2', cursive;
    margin-top: 2rem;
    font-weight: bold;
    animation: bounceIn 0.7s;
  }
</style>
<div class="quiz-container">
  <img src="https://cdn-icons-png.flaticon.com/512/189/189665.png" alt="Mascot" class="mascot" id="mascot">
  <div class="score-panel" id="scorePanel">Score: 0</div>
  <div class="progress-bar"><div class="progress" id="progressBar" style="width:0%"></div></div>
  <div id="quizGame">
    <!-- Quiz game will be rendered here by JS -->
  </div>
</div>
<script>
  // Example questions data (replace with context from Django)
  const questions = [
  { type: 'multiple_choice', question: 'What sound does the letter "A" make in "Apple"?', options: ['/æ/ (aah, as in apple)', '/ɑː/ (ahh, as in father)', '/eɪ/ (ay, as in cake)', '/ə/ (uh, as in about)'], answer: 0 },
    { type: 'fill_blank', question: 'The word "Ball" starts with the letter ___', answer: 'B' },
    { type: 'matching', question: 'Match the word to its starting sound: Cat', options: ['/k/', '/s/', '/t/', '/d/'], answer: 0 },
    { type: 'true_false', question: 'The letter "E" in "Elephant" makes the /e/ sound.', answer: false },
    { type: 'rearrangement', question: 'Rearrange the letters to make a word: G O D', answer: 'Dog' },
    { type: 'odd_one_out', question: 'Which word does NOT start with the /s/ sound?', options: ['Sun', 'Snake', 'Cat', 'Sock'], answer: 2 },
    { type: 'multiple_choice', question: 'Which word contains the blend "ch"?', options: ['Chair', 'Cat', 'Hat', 'Apple'], answer: 0 },
    { type: 'fill_blank', question: 'The word "Queen" starts with the blend ___.', answer: 'Qu' },
    { type: 'matching', question: 'Match the word to its starting sound: Rabbit', options: ['/r/', '/b/', '/g/', '/l/'], answer: 0 },
    { type: 'true_false', question: '"Kite" starts with the /k/ sound.', answer: true },
    { type: 'multiple_choice', question: 'Which word contains the digraph "sh"?', options: ['Ship', 'Sun', 'Hat', 'Pig'], answer: 0 },
    { type: 'fill_blank', question: 'The word "Umbrella" starts with the letter ___.', answer: 'U' },
    { type: 'rearrangement', question: 'Rearrange the letters to make a word: N E S T', answer: 'Nest' },
    { type: 'odd_one_out', question: 'Which word does NOT start with the /d/ sound?', options: ['Dog', 'Duck', 'Cat', 'Drum'], answer: 2 },
    { type: 'multiple_choice', question: 'What sound does the letter "X" make in "Xylophone"?', options: ['/ks/', '/z/', '/s/', '/x/'], answer: 1 },
    { type: 'fill_blank', question: 'The word "Zebra" starts with the letter ___.', answer: 'Z' },
    { type: 'matching', question: 'Match the word to its starting sound: Lion', options: ['/l/', '/n/', '/r/', '/g/'], answer: 0 },
    { type: 'true_false', question: '"Violin" starts with the /v/ sound.', answer: true },
    { type: 'multiple_choice', question: 'Which word starts with the /m/ sound?', options: ['Monkey', 'Lion', 'Rabbit', 'Goat'], answer: 0 },
    { type: 'fill_blank', question: 'The word "Apple" starts with the letter ___.', answer: 'A' },
    { type: 'rearrangement', question: 'Rearrange the letters to make a word: S U N', answer: 'Sun' },
    { type: 'odd_one_out', question: 'Which word does NOT start with the /b/ sound?', options: ['Ball', 'Bat', 'Cat', 'Bag'], answer: 2 },
    { type: 'multiple_choice', question: 'Which word starts with the /t/ sound?', options: ['Tiger', 'Lion', 'Rabbit', 'Goat'], answer: 0 },
    { type: 'fill_blank', question: 'The word "Thumb" starts with the blend ___.', answer: 'Th' },
    { type: 'true_false', question: '"Fish" starts with the /f/ sound.', answer: true }
  ];

  let current = 0;
  let score = 0;

  function renderQuestion() {
    updateProgress();
    updateScore();
    const q = questions[current];
    let html = `<div class='quiz-question'>Question ${current+1} of ${questions.length}<br>${q.question}</div>`;
    if (q.type === 'multiple_choice' || q.type === 'matching' || q.type === 'odd_one_out') {
      html += `<div class='quiz-options'>`;
      q.options.forEach((opt, i) => {
        let speakHint = opt;
        // For first question, extract only the pronunciation hint
        if (current === 0) {
          const match = opt.match(/\(([^)]+)\)/);
          speakHint = match ? match[1] : opt;
        }
  html += `<button class='quiz-option' onclick='checkAnswer(${i}); speakOptionHint(${JSON.stringify(speakHint)});' id='option${i}'>${opt}</button>`;
      });
// Speak only the kid-friendly hint for first question options
function speakOptionHint(hint) {
  if ('speechSynthesis' in window) {
    var utter = new SpeechSynthesisUtterance(hint);
    utter.lang = 'en-US';
    utter.pitch = 1.3;
    utter.rate = 1.1;
    window.speechSynthesis.speak(utter);
  }
}
      html += `</div>`;
    } else if (q.type === 'fill_blank' || q.type === 'rearrangement') {
      html += `<input type='text' id='fillInput' class='quiz-option' placeholder='Type your answer'>`;
      html += `<button class='quiz-next-btn' onclick='checkFillBlank()' id='submitBtn'>Submit</button>`;
    } else if (q.type === 'true_false') {
      html += `<div class='quiz-options'>
        <button class='quiz-option' onclick='checkAnswer(true)' id='optionTrue'>True</button>
        <button class='quiz-option' onclick='checkAnswer(false)' id='optionFalse'>False</button>
      </div>`;
    }
    document.getElementById('quizGame').innerHTML = html;
    setMascot('neutral');
    window.answered = false;
  }

  function checkAnswer(selected) {
    if (window.answered) return;
    window.answered = true;
    const q = questions[current];
    let correct = false;
    if (q.type === 'multiple_choice' || q.type === 'matching' || q.type === 'odd_one_out') {
      correct = selected === q.answer;
      // Disable all option buttons
      q.options.forEach((_, i) => {
        const btn = document.getElementById('option'+i);
        if (btn) btn.disabled = true;
      });
    } else if (q.type === 'true_false') {
      correct = selected === q.answer;
      const btnTrue = document.getElementById('optionTrue');
      const btnFalse = document.getElementById('optionFalse');
      if (btnTrue) btnTrue.disabled = true;
      if (btnFalse) btnFalse.disabled = true;
    }
    showFeedback(correct);
  }

  function checkFillBlank() {
    if (window.answered) return;
    window.answered = true;
    const q = questions[current];
    const val = document.getElementById('fillInput').value.trim();
    const btn = document.getElementById('submitBtn');
    if (btn) btn.style.display = 'none';
    const input = document.getElementById('fillInput');
    if (input) input.style.display = 'none';
    showFeedback(val.toUpperCase() === q.answer.toUpperCase());
  }

  function showFeedback(correct) {
    let msg = correct ? 'Correct! 🎉' : 'Wrong answer!';
    let html = `<div class='quiz-feedback'>${msg}</div>`;
    html += `<button class='quiz-next-btn' onclick='nextQuestion()'>Next</button>`;
    document.getElementById('quizGame').innerHTML += html;
    if (correct) {
      score++;
      setMascot('happy');
      showConfetti();
      playSound('correct');
    } else {
      setMascot('sad');
      playSound('wrong');
    }
    updateScore();
  }

  function nextQuestion() {
    current++;
    if (current < questions.length) {
      renderQuestion();
    } else {
      showLevelComplete();
    }
  }

  function updateProgress() {
    const percent = Math.round((current / questions.length) * 100);
    document.getElementById('progressBar').style.width = percent + '%';
  }

  function updateScore() {
    document.getElementById('scorePanel').innerText = `Score: ${score}`;
  }

  function setMascot(state) {
    const mascot = document.getElementById('mascot');
    if (state === 'happy') {
      mascot.src = 'https://cdn-icons-png.flaticon.com/512/189/189665.png';
      mascot.style.background = '#43e97b';
    } else if (state === 'sad') {
      mascot.src = 'https://cdn-icons-png.flaticon.com/512/189/189665.png';
      mascot.style.background = '#ff4066';
    } else {
      mascot.src = 'https://cdn-icons-png.flaticon.com/512/189/189665.png';
      mascot.style.background = '#ffd60a';
    }
  }

  function showConfetti() {
    var confetti = document.createElement('span');
    confetti.className = 'confetti';
    confetti.innerHTML = '🎉';
    document.body.appendChild(confetti);
    setTimeout(function(){ confetti.remove(); }, 1200);
  }

  function playSound(type) {
    if (type === 'correct') {
      var audio = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b2b3e.mp3');
      audio.play();
    } else {
      var audio = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b2b3e.mp3');
      audio.play();
    }
  }

  function showLevelComplete() {
    document.getElementById('quizGame').innerHTML = `<div class='level-complete'>Game Complete!<br>🏅</div>
      <div class='quiz-feedback'>Your score: ${score} / ${questions.length}</div>`;
    setMascot('happy');
    showConfetti();
    playSound('correct');
  }

  window.onload = renderQuestion;
</script>
{% endblock %}
