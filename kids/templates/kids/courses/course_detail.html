{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-body">
          <h2 class="fw-bold mb-2" style="color:#2d6a4f;"><i class="bi bi-palette" style="color:#ff595e;"></i> {{ course.name }}</h2>
          <span class="badge bg-info">{{ course.subject.name }}</span>
          <span class="badge bg-success">{{ course.level }}</span>
          <span class="badge bg-warning text-dark">Ages {{ course.age_group.min_age }}-{{ course.age_group.max_age }}</span>
          <p class="mt-3" style="font-size:1.1rem;">{{ course.description }}</p>
        </div>
      </div>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h4 class="mb-3 text-primary"><i class="bi bi-lightbulb"></i> Lessons</h4>
          {% if not enrolled %}
            <form method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-success mb-3">Start Course</button>
            </form>
            <div class="alert alert-warning">You must start the course to access lessons.</div>
              <!-- Progress tracker and debug enrollment status removed -->
          {% endif %}
          {% if lessons and enrolled %}
              <!-- Progress tracker and debug enrollment status removed -->
            <ul class="list-group list-group-flush">
              {% for lesson in lessons %}
                {% with completion=lesson.completions.filter(user=request.user).first %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ lesson.title }}</strong><br>
                    <span>{{ lesson.content|linebreaks }}</span>
                  </div>
                  <div class="text-end">
                    <div style="font-size:0.9rem; color:#888;">Debug: completion.completed_quiz = {{ completion.completed_quiz }}</div>
                    {% if completion and completion.completed_quiz %}
                      <span class="badge bg-success mb-2">Completed</span><br>
                      <a href="{% url 'lesson_detail' lesson.id %}" class="btn btn-outline-success btn-sm">Review Lesson</a>
                    {% else %}
                      <a href="{% url 'lesson_detail' lesson.id %}" class="btn btn-primary btn-sm">Go to Lesson</a>
                    {% endif %}
                  </div>
                </li>
                {% endwith %}
              {% endfor %}
            </ul>
          {% elif lessons %}
            <ul class="list-group list-group-flush">
              {% for lesson in lessons %}
                <li class="list-group-item">
                  <strong>{{ lesson.title }}</strong><br>
                  <span>{{ lesson.content|linebreaks }}</span>
                  <button class="btn btn-secondary btn-sm mt-2" disabled>Locked</button>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="alert alert-info">No lessons available yet for this course.</div>
          {% endif %}
        </div>
      </div>
      <a href="{% url 'kids_online_platform' %}" class="btn btn-secondary">Back to Courses</a>
    </div>
  </div>
</div>
{% endblock %}
